<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>多天均值查询 - Excel2SQL</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }

      .btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn:hover {
        background-color: #2980b9;
      }

      .btn-primary {
        background-color: #3498db;
      }

      .btn-primary:hover {
        background-color: #2980b9;
      }

      .result-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .result-table th,
      .result-table td {
        border: 1px solid #ddd;
        padding: 8px 12px;
        text-align: left;
      }

      .result-table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      .result-table tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      .alert {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .pagination button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background-color: white;
        cursor: pointer;
        border-radius: 4px;
      }

      .pagination button:hover {
        background-color: #f8f9fa;
      }

      .pagination button.active {
        background-color: #3498db;
        color: white;
      }

      .query-result-info {
        margin: 15px 0;
        font-weight: 500;
      }

      .hidden {
        display: none;
      }

      .sql-editor {
        width: 100%;
        min-height: 150px;
        font-family: monospace;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }

      /* 为表格容器添加滚动条 */
      .table-container {
        overflow-x: auto;
        max-width: 100%;
        margin: 10px 0;
      }

      .table-container table {
        min-width: 100%;
      }

      /* 日期选择器样式 */
      .year-month-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      
      .year-month-selector .form-group {
        margin-bottom: 0;
      }

      .select-all-row {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
      }

      .select-all-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        cursor: pointer;
      }

      .select-all-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .checkboxes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 10px;
      }

      .date-option label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
        font-weight: normal;
      }

      .date-option label:hover {
        background-color: #f5f5f5;
      }

      .date-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }

      .select-all-container {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
      }
      
      .select-all-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        cursor: pointer;
      }
      
      .select-all-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }
      
      .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 5px;
      }
      
      .radio-group label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: normal;
      }
      
      .radio-group input[type="radio"] {
        margin-right: 8px;
      }
      
      /* 新增的灵活筛选样式 */
      .flexible-filter {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      
      .filter-section {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background-color: #fafafa;
      }
      
      .filter-section h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      
      .filter-options {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .filter-option {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .filter-option input[type="radio"] {
        margin: 0;
        width: 18px;
        height: 18px;
      }
      
      .filter-option label {
        font-weight: 500;
        cursor: pointer;
      }
      
      .year-selector,
      .month-selector {
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: white;
      }
      
      .year-item,
      .month-item {
        display: inline-block;
        margin: 5px;
      }
      
      .year-item label,
      .month-item label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: normal;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 4px;
        transition: all 0.2s;
        border: 1px solid #ddd;
        background-color: white;
      }
      
      .year-item label:hover,
      .month-item label:hover {
        background-color: #e3f2fd;
        border-color: #3498db;
      }
      
      .year-item input[type="checkbox"],
      .month-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }
      
      .date-range-inputs {
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: white;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .date-range-inputs .form-group {
        margin-bottom: 0;
      }
      
      .date-range-inputs input[type="date"] {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      
      .custom-dates-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 15px;
        border-radius: 4px;
        background-color: white;
      }
      
      .checkboxes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 10px;
      }
      
      .date-option label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
        font-weight: normal;
      }
      
      .date-option label:hover {
        background-color: #f5f5f5;
      }
      
      .date-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }
      
      .select-all-container {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
      }
      
      .select-all-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        cursor: pointer;
      }
      
      .select-all-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }
      
      .year-month-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      
      .year-month-selector .form-group {
        margin-bottom: 0;
      }
      
      .hidden {
        display: none;
      }
      
      /* 新增的手动选择和结果展示样式 */
      .manual-selection-and-results {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      .manual-selection-section {
        grid-column: 1;
      }
      
      .selected-dates-section {
        grid-column: 2;
      }
      
      .selected-dates-display {
        min-height: 200px;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: white;
      }
      
      .selected-dates-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      
      .selected-dates-title {
        font-weight: 500;
        color: #333;
      }
      
      .clear-all-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      
      .clear-all-btn:hover {
        background-color: #c0392b;
      }
      
      .selected-dates-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .selected-date-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #e3f2fd;
        padding: 8px 12px;
        border-radius: 20px;
      }
      
      .selected-date-text {
        font-size: 14px;
        color: #333;
      }
      
      .remove-date-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        padding: 0;
      }
      
      .remove-date-btn:hover {
        background-color: #c0392b;
      }
      
      .no-selected-dates {
        color: #999;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }
      
      @media (max-width: 768px) {
        .manual-selection-and-results {
          grid-template-columns: 1fr;
        }
        
        .manual-selection-section,
        .selected-dates-section {
          grid-column: 1;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>多天均值查询</h1>
        <div>
          <a href="/" class="btn">返回首页</a>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="card">
        <h2>多天均值查询</h2>
        <form
          id="daily-averages-form"
          onsubmit="executeDailyAveragesQuery(event)"
        >
          <div class="form-group">
            <label>数据类型:</label>
            <div class="radio-group">
              <label>
                <input type="radio" name="data-type" value="日前节点电价" checked />
                日前节点电价
              </label>
              <label>
                <input type="radio" name="data-type" value="实时节点电价" />
                实时节点电价
              </label>
            </div>
          </div>

          <!-- 灵活的日期筛选选项 -->
          <div class="form-group">
            <label>日期筛选方式:</label>
            <div class="flexible-filter">
              <!-- 按年份筛选 -->
              <div class="filter-section">
                <h3>按年份筛选</h3>
                <div class="filter-options">
                  <div class="filter-option">
                    <input type="radio" name="filter-type" id="filter-by-year" value="year" onchange="toggleFilterSection('year')">
                    <label for="filter-by-year">选择年份</label>
                  </div>
                  <div class="year-selector" id="year-selector" style="display: none;">
                    <div class="select-all-container">
                      <label class="select-all-label">
                        <input type="checkbox" id="select-all-years" onchange="toggleAllYears(this.checked)">
                        <span>全选</span>
                      </label>
                    </div>
                    <!-- 年份选项将通过JavaScript动态生成 -->
                  </div>
                </div>
              </div>

              <!-- 按月份筛选 -->
              <div class="filter-section">
                <h3>按月份筛选</h3>
                <div class="filter-options">
                  <div class="filter-option">
                    <input type="radio" name="filter-type" id="filter-by-month" value="month" onchange="toggleFilterSection('month')">
                    <label for="filter-by-month">选择年份和月份</label>
                  </div>
                  <div class="month-selector" id="month-selector" style="display: none;">
                    <div class="form-group">
                      <label for="year-select">选择年份:</label>
                      <select id="year-select" onchange="updateMonthOptions()">
                        <option value="">选择年份</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <div id="month-checkboxes">
                        <div class="select-all-container">
                          <label class="select-all-label">
                            <input type="checkbox" id="select-all-months" onchange="toggleAllMonths(this.checked)">
                            <span>全选月份</span>
                          </label>
                        </div>
                        <!-- 月份选项将通过JavaScript动态生成 -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 自定义日期范围 -->
              <div class="filter-section">
                <h3>自定义日期范围</h3>
                <div class="filter-options">
                  <div class="filter-option">
                    <input type="radio" name="filter-type" id="filter-by-range" value="range" onchange="toggleFilterSection('range')">
                    <label for="filter-by-range">选择日期范围</label>
                  </div>
                  <div class="date-range-inputs" id="date-range-inputs" style="display: none;">
                    <div class="form-group">
                      <label for="start-date">开始日期:</label>
                      <input type="date" id="start-date">
                    </div>
                    <div class="form-group">
                      <label for="end-date">结束日期:</label>
                      <input type="date" id="end-date">
                    </div>
                    <button type="button" class="btn" onclick="applyDateRange()">应用日期范围</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 手动选择日期和查询结果 -->
          <div class="manual-selection-and-results">
            <!-- 手动选择日期 -->
            <div class="filter-section manual-selection-section">
              <h3>手动选择日期</h3>
              <div class="filter-options">
                <div class="filter-option">
                  <input type="radio" name="filter-type" id="filter-by-custom" value="custom" onchange="toggleFilterSection('custom')" checked>
                  <label for="filter-by-custom">手动选择日期</label>
                </div>
                <div id="custom-date-selector">
                  <div class="year-month-selector">
                    <div class="form-group">
                      <label for="custom-year-select">选择年份:</label>
                      <select id="custom-year-select" onchange="updateCustomDateOptions()">
                        <option value="">选择年份</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="custom-month-select">选择月份:</label>
                      <select id="custom-month-select" onchange="updateCustomDateOptions()">
                        <option value="">选择月份</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <div id="custom-date-checkboxes" class="custom-dates-container">
                      <div class="select-all-container">
                        <label class="select-all-label">
                          <input type="checkbox" id="select-all-dates" onchange="toggleAllDates(this.checked)">
                          <span>全选日期</span>
                        </label>
                      </div>
                      <!-- 日期复选框将在这里动态生成 -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 已选择的日期显示 -->
            <div class="filter-section selected-dates-section">
              <div class="selected-dates-header">
                <div class="selected-dates-title">已选择的日期</div>
                <button type="button" class="clear-all-btn" onclick="clearAllSelectedDates()">全部删除</button>
              </div>
              <div id="selected-dates-display" class="selected-dates-display">
                <div class="no-selected-dates">暂无选择的日期</div>
              </div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">查询</button>
          <button
            type="button"
            class="btn btn-success"
            id="export-btn"
            onclick="exportDailyAveragesData()"
            style="display: none"
          >
            导出Excel
          </button>
        </form>
      </div>

      <div id="result-section" class="card hidden">
        <h2>查询结果</h2>
        <div id="alerts"></div>
        <div class="result-info">
          <span id="result-info">总共 0 条记录</span>
        </div>
        <div class="table-container">
          <table class="result-table">
            <thead>
              <tr id="result-header"></tr>
            </thead>
            <tbody id="result-body"></tbody>
          </table>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>

    <footer>
      <div class="container">
        <p>Excel2SQL - 数据导入工具 &copy; 2025</p>
      </div>
    </footer>

    <script>
      // 全局变量存储查询结果
      let queryResult = [];
      let currentPage = 1;
      const itemsPerPage = 20;

      // 页面加载完成后初始化
      document.addEventListener("DOMContentLoaded", function () {
        loadTableList();
        document
          .getElementById("daily-averages-form")
          .addEventListener("submit", executeDailyAveragesQuery);
          
        // 初始化手动选择日期存储
        window.manuallySelectedDates = new Set();
          
        // 初始化年份选项
        setTimeout(() => {
          populateYearOptions();
          populateCustomYearMonthOptions();
        }, 1000);
      });

      // 加载表列表
      function loadTableList() {
        fetch("/tables")
          .then((response) => response.json())
          .then((data) => {
            // 为多天均值查询准备日期选项
            populateDateOptions(data.tables);
            populateYearMonthOptions();
          })
          .catch((error) => {
            showAlert("加载表列表失败: " + error.message, "error");
          });
      }

      // 为多天均值查询填充日期选项
      function populateDateOptions(tables) {
        // 从表名中提取日期信息
        const dates = [];
        tables.forEach((table) => {
          // 匹配 power_data_YYYYMMDD 格式的表名
          const match = table.match(/^power_data_(\d{8})$/);
          if (match) {
            const dateStr = match[1];
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            dates.push({
              table: table,
              date: `${year}-${month}-${day}`,
              year: year,
              month: month,
              day: day,
            });
          }
        });

        // 保存日期信息供后续使用
        window.availableDates = dates;
      }

      // 添加年份和月份选项
      function populateYearMonthOptions() {
        if (!window.availableDates) return;

        const years = [
          ...new Set(window.availableDates.map((d) => d.year)),
        ].sort((a, b) => b - a);

        const yearSelect = document.getElementById("year-select");
        const customYearSelect = document.getElementById("custom-year-select");

        // 清空现有的选项
        yearSelect.innerHTML = '<option value="">选择年份</option>';
        customYearSelect.innerHTML = '<option value="">选择年份</option>';

        // 填充年份选择器
        years.forEach((year) => {
          const option1 = document.createElement("option");
          option1.value = year;
          option1.textContent = year;
          yearSelect.appendChild(option1);

          const option2 = document.createElement("option");
          option2.value = year;
          option2.textContent = year;
          customYearSelect.appendChild(option2);
        });

        // 默认选择最新年份
        if (years.length > 0) {
          yearSelect.value = years[0];
          customYearSelect.value = years[0];
          updateMonthOptions();
          updateCustomDateOptions();
        }
      }

      // 根据选择的年份和月份更新日期选项
      function updateDateOptions() {
        const yearSelect = document.getElementById("year-select");
        const monthSelect = document.getElementById("month-select");
        const year = yearSelect.value;
        const month = monthSelect.value;

        const dateCheckboxes = document.getElementById("date-checkboxes");
        const noDatesMessage = document.getElementById("no-dates-message");

        // 清空现有内容
        dateCheckboxes.innerHTML = "";

        if (!year || !month || !window.availableDates) {
          // 显示无数据提示
          noDatesMessage.style.display = "block";
          dateCheckboxes.appendChild(noDatesMessage);
          return;
        }

        // 筛选匹配的日期
        const filteredDates = window.availableDates.filter(
          (d) => d.year === year && d.month === month
        );

        if (filteredDates.length === 0) {
          // 显示无数据提示
          noDatesMessage.style.display = "block";
          dateCheckboxes.appendChild(noDatesMessage);
          return;
        }

        // 隐藏无数据提示
        noDatesMessage.style.display = "none";

        // 创建全选行
        const selectAllDiv = document.createElement("div");
        selectAllDiv.className = "select-all-row";
        selectAllDiv.innerHTML = `
          <label class="select-all-label">
            <input type="checkbox" id="select-all-checkbox" onchange="toggleAllDates(this.checked)">
            <span>全选</span>
          </label>
        `;
        dateCheckboxes.appendChild(selectAllDiv);

        // 按日期排序
        filteredDates.sort((a, b) => a.date.localeCompare(b.date));

        // 创建复选框容器
        const checkboxesContainer = document.createElement("div");
        checkboxesContainer.className = "checkboxes-container";

        // 创建复选框
        filteredDates.forEach((dateInfo) => {
          const div = document.createElement("div");
          div.className = "date-option";
          div.innerHTML = `
            <label>
              <input type="checkbox" name="selected-dates" value="${dateInfo.date}">
              ${dateInfo.date} (${dateInfo.table})
            </label>
          `;
          checkboxesContainer.appendChild(div);
        });

        dateCheckboxes.appendChild(checkboxesContainer);

        // 重新添加无数据提示（隐藏状态）
        dateCheckboxes.appendChild(noDatesMessage);
      }

      // 全选/取消全选日期
      function toggleAllDates(checked) {
        const checkboxes = document.querySelectorAll(
          'input[name="selected-dates"]'
        );
        checkboxes.forEach((checkbox) => {
          checkbox.checked = checked;
        });
      }

      // 切换筛选部分显示/隐藏
      function toggleFilterSection(selectedType) {
        // 隐藏所有筛选器
        document.getElementById('year-selector').style.display = 'none';
        document.getElementById('month-selector').style.display = 'none';
        document.getElementById('date-range-inputs').style.display = 'none';
        document.getElementById('custom-date-selector').style.display = 'none';
        
        // 显示选中的筛选器
        switch(selectedType) {
          case 'year':
            document.getElementById('year-selector').style.display = 'block';
            break;
          case 'month':
            document.getElementById('month-selector').style.display = 'block';
            break;
          case 'range':
            document.getElementById('date-range-inputs').style.display = 'block';
            break;
          case 'custom':
            document.getElementById('custom-date-selector').style.display = 'block';
            break;
        }
      }

      // 填充年份选项
      function populateYearOptions() {
        if (!window.availableDates) return;
        
        const years = [...new Set(window.availableDates.map(d => d.year))].sort((a, b) => b - a);
        const yearSelector = document.getElementById('year-selector');
        
        // 保留全选容器，只清空年份选项
        const selectAllContainer = yearSelector.querySelector('.select-all-container');
        yearSelector.innerHTML = '';
        yearSelector.appendChild(selectAllContainer);
        
        years.forEach(year => {
          const div = document.createElement('div');
          div.className = 'year-item';
          div.innerHTML = `
            <label>
              <input type="checkbox" name="selected-years" value="${year}">
              ${year}年
            </label>
          `;
          yearSelector.appendChild(div);
        });
      }

      // 全选/取消全选年份
      function toggleAllYears(checked) {
        const checkboxes = document.querySelectorAll('input[name="selected-years"]');
        checkboxes.forEach((checkbox) => {
          checkbox.checked = checked;
        });
      }

      // 更新月份选项
      function updateMonthOptions() {
        const yearSelect = document.getElementById('year-select');
        const selectedYear = yearSelect.value;
        const monthCheckboxes = document.getElementById('month-checkboxes');
        
        // 保留全选容器，只清空月份选项
        const selectAllContainer = monthCheckboxes.querySelector('.select-all-container');
        monthCheckboxes.innerHTML = '';
        if (selectAllContainer) {
          monthCheckboxes.appendChild(selectAllContainer);
        }
        
        if (!selectedYear) {
          return;
        }
        
        const months = [
          { name: '一月', value: '01' },
          { name: '二月', value: '02' },
          { name: '三月', value: '03' },
          { name: '四月', value: '04' },
          { name: '五月', value: '05' },
          { name: '六月', value: '06' },
          { name: '七月', value: '07' },
          { name: '八月', value: '08' },
          { name: '九月', value: '09' },
          { name: '十月', value: '10' },
          { name: '十一月', value: '11' },
          { name: '十二月', value: '12' }
        ];
        
        months.forEach((month, index) => {
          // 检查该年月是否有数据
          const hasData = window.availableDates.some(d => 
            d.year === selectedYear && d.month === month.value
          );
          
          if (hasData) {
            const div = document.createElement('div');
            div.className = 'month-item';
            div.innerHTML = `
              <label>
                <input type="checkbox" name="selected-months" value="${month.value}">
                ${month.name}
              </label>
            `;
            monthCheckboxes.appendChild(div);
          }
        });
      }

      // 全选/取消全选月份
      function toggleAllMonths(checked) {
        const checkboxes = document.querySelectorAll('input[name="selected-months"]');
        checkboxes.forEach((checkbox) => {
          checkbox.checked = checked;
        });
      }

      // 填充自定义年月选项
      function populateCustomYearMonthOptions() {
        if (!window.availableDates) return;
        
        const years = [...new Set(window.availableDates.map(d => d.year))].sort((a, b) => b - a);
        const yearSelect = document.getElementById('custom-year-select');
        const monthSelect = document.getElementById('custom-month-select');
        
        // 保存当前选择
        const currentYearSelection = yearSelect.value;
        const currentMonthSelection = monthSelect.value;
        
        // 清空并重新填充年份
        yearSelect.innerHTML = '<option value="">选择年份</option>';
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          if (year === currentYearSelection) {
            option.selected = true;
          }
          yearSelect.appendChild(option);
        });
        
        // 清空并重新填充月份
        monthSelect.innerHTML = '<option value="">选择月份</option>';
        const months = [
          { name: '一月', value: '01' },
          { name: '二月', value: '02' },
          { name: '三月', value: '03' },
          { name: '四月', value: '04' },
          { name: '五月', value: '05' },
          { name: '六月', value: '06' },
          { name: '七月', value: '07' },
          { name: '八月', value: '08' },
          { name: '九月', value: '09' },
          { name: '十月', value: '10' },
          { name: '十一月', value: '11' },
          { name: '十二月', value: '12' }
        ];
        
        months.forEach(month => {
          const option = document.createElement('option');
          option.value = month.value;
          option.textContent = month.name;
          if (month.value === currentMonthSelection) {
            option.selected = true;
          }
          monthSelect.appendChild(option);
        });
        
        // 触发日期更新
        updateCustomDateOptions();
      }

      // 更新自定义日期选项
      function updateCustomDateOptions() {
        const yearSelect = document.getElementById('custom-year-select');
        const monthSelect = document.getElementById('custom-month-select');
        const selectedYear = yearSelect.value;
        const selectedMonth = monthSelect.value;
        
        const dateCheckboxes = document.getElementById('custom-date-checkboxes');
        
        // 获取当前已选中的日期（从全局存储中）
        if (!window.manuallySelectedDates) {
          window.manuallySelectedDates = new Set();
        }
        
        // 保留全选容器，只清空日期选项
        const selectAllContainer = dateCheckboxes.querySelector('.select-all-container');
        dateCheckboxes.innerHTML = '';
        if (selectAllContainer) {
          dateCheckboxes.appendChild(selectAllContainer);
        }
        
        // 根据筛选条件过滤日期
        let filteredDates = window.availableDates;
        if (selectedYear) {
          filteredDates = filteredDates.filter(d => d.year === selectedYear);
        }
        
        if (selectedMonth) {
          filteredDates = filteredDates.filter(d => d.month === selectedMonth);
        }
        
        if (filteredDates.length === 0) {
          dateCheckboxes.innerHTML = '<div class="alert alert-warning">该时间段无数据</div>';
          if (selectAllContainer) {
            dateCheckboxes.prepend(selectAllContainer);
          }
          return;
        }
        
        // 按日期排序
        filteredDates.sort((a, b) => a.date.localeCompare(b.date));
        
        // 创建复选框容器
        const checkboxesContainer = document.createElement('div');
        checkboxesContainer.className = 'checkboxes-container';
        
        // 创建复选框
        filteredDates.forEach((dateInfo) => {
          const div = document.createElement('div');
          div.className = 'date-option';
          const isChecked = window.manuallySelectedDates.has(dateInfo.date) ? 'checked' : '';
          div.innerHTML = `
            <label>
              <input type="checkbox" name="selected-dates" value="${dateInfo.date}" ${isChecked} onchange="updateManualSelection(this)">
              ${dateInfo.date}
            </label>
          `;
          checkboxesContainer.appendChild(div);
        });
        
        dateCheckboxes.appendChild(checkboxesContainer);
        if (selectAllContainer) {
          dateCheckboxes.prepend(selectAllContainer);
        }
        
        // 更新全选状态
        updateSelectAllState();
      }
      
      // 更新手动选择的日期
      function updateManualSelection(checkbox) {
        if (!window.manuallySelectedDates) {
          window.manuallySelectedDates = new Set();
        }
        
        if (checkbox.checked) {
          window.manuallySelectedDates.add(checkbox.value);
        } else {
          window.manuallySelectedDates.delete(checkbox.value);
        }
        
        // 更新全选状态
        updateSelectAllState();
        
        // 更新已选择日期的显示
        updateSelectedDatesDisplay();
      }
      
      // 全选/取消全选日期
      function toggleAllDates(checked) {
        const checkboxes = document.querySelectorAll('input[name="selected-dates"]');
        checkboxes.forEach((checkbox) => {
          checkbox.checked = checked;
          // 更新全局选择状态
          if (!window.manuallySelectedDates) {
            window.manuallySelectedDates = new Set();
          }
          
          if (checked) {
            window.manuallySelectedDates.add(checkbox.value);
          } else {
            window.manuallySelectedDates.delete(checkbox.value);
          }
        });
        
        // 更新已选择日期的显示
        updateSelectedDatesDisplay();
      }
      
      // 更新已选择日期的显示
      function updateSelectedDatesDisplay() {
        const displayArea = document.getElementById('selected-dates-display');
        if (!displayArea) return;
        
        if (!window.manuallySelectedDates || window.manuallySelectedDates.size === 0) {
          displayArea.innerHTML = '<div class="no-selected-dates">暂无选择的日期</div>';
          return;
        }
        
        // 转换为数组并排序
        const selectedDates = Array.from(window.manuallySelectedDates).sort();
        
        // 创建显示内容
        let html = '<div class="selected-dates-list">';
        selectedDates.forEach(date => {
          html += `
            <div class="selected-date-item">
              <span class="selected-date-text">${date}</span>
              <button type="button" class="remove-date-btn" onclick="removeSelectedDate('${date}')">×</button>
            </div>
          `;
        });
        html += '</div>';
        
        displayArea.innerHTML = html;
      }
      
      // 删除单个已选择的日期
      function removeSelectedDate(date) {
        // 从全局存储中删除
        if (window.manuallySelectedDates) {
          window.manuallySelectedDates.delete(date);
        }
        
        // 取消对应的复选框选中状态
        const checkboxes = document.querySelectorAll(`input[name="selected-dates"][value="${date}"]`);
        checkboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        
        // 更新全选状态
        updateSelectAllState();
        
        // 更新显示
        updateSelectedDatesDisplay();
      }
      
      // 清除所有已选择的日期
      function clearAllSelectedDates() {
        if (!window.manuallySelectedDates || window.manuallySelectedDates.size === 0) {
          return;
        }
        
        // 清空全局存储
        window.manuallySelectedDates.clear();
        
        // 取消所有复选框的选中状态
        const checkboxes = document.querySelectorAll('input[name="selected-dates"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
        
        // 更新全选状态
        updateSelectAllState();
        
        // 更新显示
        updateSelectedDatesDisplay();
      }
      
      // 更新全选状态
      function updateSelectAllState() {
        const allCheckboxes = document.querySelectorAll('input[name="selected-dates"]');
        const checkedCheckboxes = document.querySelectorAll('input[name="selected-dates"]:checked');
        const selectAllCheckbox = document.getElementById('select-all-dates');
        
        if (selectAllCheckbox && allCheckboxes.length > 0) {
          selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
          selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
        }
      }
      
      // 监听日期选择变化，更新全选状态
      document.addEventListener('change', function(e) {
        if (e.target && e.target.name === 'selected-dates') {
          updateSelectAllState();
        }
      });

      // 应用日期范围
      function applyDateRange() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
          showAlert('请选择完整的日期范围', 'warning');
          return;
        }
        
        if (startDate > endDate) {
          showAlert('开始日期不能晚于结束日期', 'warning');
          return;
        }
        
        // 存储选择的日期范围，供查询时使用
        window.selectedDateRange = {
          start: startDate,
          end: endDate
        };
        
        showAlert(`已选择日期范围: ${startDate} 到 ${endDate}`, 'info');
      }

      // 执行多天均值查询
      function executeDailyAveragesQuery(event) {
        event.preventDefault();
        
        try {
          console.log("开始执行多天均值查询...");

          // 获取选中的筛选类型
          const selectedFilterType = document.querySelector('input[name="filter-type"]:checked')?.value || 'custom';
          
          let dates = [];
          
          // 根据筛选类型获取日期
          switch(selectedFilterType) {
            case 'year':
              // 获取选中的年份
              const selectedYearCheckboxes = document.querySelectorAll('input[name="selected-years"]:checked');
              const selectedYears = Array.from(selectedYearCheckboxes).map(cb => cb.value);
              
              if (selectedYears.length === 0) {
                showAlert("请选择至少一个年份", "warning");
                return;
              }
              
              // 获取这些年份的所有日期
              dates = window.availableDates
                .filter(d => selectedYears.includes(d.year))
                .map(d => d.date);
              break;
              
            case 'month':
              // 获取选中的年份和月份
              const selectedYear = document.getElementById('year-select').value;
              const selectedMonthCheckboxes = document.querySelectorAll('input[name="selected-months"]:checked');
              const selectedMonths = Array.from(selectedMonthCheckboxes).map(cb => cb.value);
              
              if (!selectedYear) {
                showAlert("请选择年份", "warning");
                return;
              }
              
              if (selectedMonths.length === 0) {
                showAlert("请选择至少一个月份", "warning");
                return;
              }
              
              // 获取这些月份的所有日期
              dates = window.availableDates
                .filter(d => d.year === selectedYear && selectedMonths.includes(d.month))
                .map(d => d.date);
              break;
              
            case 'range':
              // 检查是否已设置日期范围
              if (!window.selectedDateRange) {
                showAlert("请先设置日期范围", "warning");
                return;
              }
              
              // 根据日期范围筛选数据
              const startDate = window.selectedDateRange.start;
              const endDate = window.selectedDateRange.end;
              
              dates = window.availableDates
                .filter(d => d.date >= startDate && d.date <= endDate)
                .map(d => d.date);
              
              if (dates.length === 0) {
                showAlert("指定日期范围内无数据", "warning");
                return;
              }
              break;
              
            case 'custom':
            default:
              // 获取手动选择的日期（从全局存储中）
              if (!window.manuallySelectedDates || window.manuallySelectedDates.size === 0) {
                showAlert("请至少选择一个日期", "warning");
                return;
              }
              
              dates = Array.from(window.manuallySelectedDates);
              break;
          }

          const dataTypeKeywordElement = document.querySelector('input[name="data-type"]:checked');
          if (!dataTypeKeywordElement) {
            showAlert("请选择数据类型", "warning");
            return;
          }
          
          const selectedDataType = dataTypeKeywordElement.value;
          console.log("选中的数据类型:", selectedDataType);
          console.log("选中的日期:", dates);

          // 构造参数
          const formData = new FormData();
          formData.append("dates", JSON.stringify(dates));
          formData.append("data_type_keyword", selectedDataType);

          // 发送请求
          fetch("/daily-averages", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              console.log("收到响应:", response);
              if (!response.ok) {
                return response.json().then((err) => {
                  console.error("服务器返回错误:", err);
                  throw new Error(err.detail || "查询失败");
                });
              }
              return response.json();
            })
            .then((data) => {
              console.log("收到数据:", data);
              // 无论是否有数据，都更新页面显示
              queryResult = data.data || [];
              displayResults();
              if (data.total > 0) {
                showAlert(
                  "查询成功，共返回 " + data.total + " 条记录",
                  "success"
                );
                // 显示导出按钮
                const exportBtn = document.getElementById("export-btn");
                if (exportBtn) {
                  exportBtn.style.display = "inline-block";
                }
              } else {
                showAlert("查询成功，但没有找到匹配的数据", "warning");
                // 隐藏导出按钮
                const exportBtn = document.getElementById("export-btn");
                if (exportBtn) {
                  exportBtn.style.display = "none";
                }
              }
            })
            .catch((error) => {
              console.error("查询错误:", error);
              showAlert("查询失败: " + error.message, "error");
              // 隐藏导出按钮
              const exportBtn = document.getElementById("export-btn");
              if (exportBtn) {
                exportBtn.style.display = "none";
              }
            });
        } catch (error) {
          console.error("查询过程中发生错误:", error);
          showAlert("查询失败: " + error.message, "error");
          // 隐藏导出按钮
          const exportBtn = document.getElementById("export-btn");
          if (exportBtn) {
            exportBtn.style.display = "none";
          }
        }
      }

      // 显示查询结果
      function displayResults() {
        const resultSection = document.getElementById("result-section");
        resultSection.classList.remove("hidden");

        // 如果没有数据，显示空表格
        if (!queryResult || queryResult.length === 0) {
          document.getElementById("result-info").textContent = "总共 0 条记录";
          document.getElementById("result-header").innerHTML = "";
          document.getElementById("result-body").innerHTML =
            '<tr><td colspan="100%">无数据</td></tr>';
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        // 更新结果信息
        document.getElementById(
          "result-info"
        ).textContent = `总共 ${queryResult.length} 条记录，当前显示第 ${currentPage} 页`;

        // 创建表头
        const headerRow = document.getElementById("result-header");
        headerRow.innerHTML = "";
        const keys = Object.keys(queryResult[0]);
        keys.forEach((key) => {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        });

        // 分页显示数据
        renderPage(currentPage);
        setupPagination();
      }

      // 渲染当前页数据
      function renderPage(page) {
        const tbody = document.getElementById("result-body");
        tbody.innerHTML = "";

        // 如果没有数据，直接返回
        if (!queryResult || queryResult.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.textContent = "无数据";
          td.colSpan = 100; // 跨越所有列
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(
          startIndex + itemsPerPage,
          queryResult.length
        );
        const pageData = queryResult.slice(startIndex, endIndex);

        pageData.forEach((row) => {
          const tr = document.createElement("tr");
          Object.keys(row).forEach((key) => {
            const td = document.createElement("td");
            const value = row[key];

            // 特殊处理 record_time 字段
            if (
              key === "record_time" &&
              value !== null &&
              value !== undefined &&
              value !== ""
            ) {
              // 处理 timedelta 对象 (如: datetime.timedelta(seconds=3600))
              if (typeof value === "object" && value.seconds !== undefined) {
                const hours = Math.floor(value.seconds / 3600);
                const minutes = Math.floor((value.seconds % 3600) / 60);
                td.textContent = `${String(hours).padStart(2, "0")}:${String(
                  minutes
                ).padStart(2, "0")}`;
              }
              // 处理秒数格式 (如: 43200)
              else if (typeof value === "number") {
                const hours = Math.floor(value / 3600);
                const minutes = Math.floor((value % 3600) / 60);
                td.textContent = `${String(hours).padStart(2, "0")}:${String(
                  minutes
                ).padStart(2, "0")}`;
              }
              // 处理数值格式时间 (如: 900 表示 09:00)
              else if (
                typeof value === "string" &&
                !isNaN(parseInt(value)) &&
                parseInt(value) < 2400
              ) {
                const numValue = parseInt(value);
                const strValue = String(numValue).padStart(4, "0");
                const hour = strValue.substring(0, 2);
                const minute = strValue.substring(2, 4);
                td.textContent = `${hour}:${minute}`;
              }
              // 处理其他数字格式
              else if (typeof value === "string" && !isNaN(parseInt(value))) {
                const numValue = parseInt(value);
                const hours = Math.floor(numValue / 3600);
                const minutes = Math.floor((numValue % 3600) / 60);
                td.textContent = `${String(hours).padStart(2, "0")}:${String(
                  minutes
                ).padStart(2, "0")}`;
              }
              // 其他情况保持原样
              else {
                td.textContent = String(value);
              }
            } else {
              // 其他字段保持原样，包括value字段
              td.textContent = value !== null ? value : "";
            }

            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      // 设置分页控件
      function setupPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        // 如果没有数据，不显示分页控件
        if (!queryResult || queryResult.length === 0) {
          return;
        }

        const totalPages = Math.ceil(queryResult.length / itemsPerPage);

        // 如果只有一页，不显示分页控件
        if (totalPages <= 1) {
          return;
        }

        // 上一页按钮
        const prevButton = document.createElement("button");
        prevButton.textContent = "上一页";
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderPage(currentPage);
            setupPagination();
            document.getElementById(
              "result-info"
            ).textContent = `总共 ${queryResult.length} 条记录，当前显示第 ${currentPage} 页`;
          }
        };
        pagination.appendChild(prevButton);

        // 页码按钮
        for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement("button");
          pageButton.textContent = i;
          pageButton.classList.toggle("active", i === currentPage);
          pageButton.onclick = () => {
            currentPage = i;
            renderPage(currentPage);
            setupPagination();
            document.getElementById(
              "result-info"
            ).textContent = `总共 ${queryResult.length} 条记录，当前显示第 ${currentPage} 页`;
          };
          pagination.appendChild(pageButton);
        }

        // 下一页按钮
        const nextButton = document.createElement("button");
        nextButton.textContent = "下一页";
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderPage(currentPage);
            setupPagination();
            document.getElementById(
              "result-info"
            ).textContent = `总共 ${queryResult.length} 条记录，当前显示第 ${currentPage} 页`;
          }
        };
        pagination.appendChild(nextButton);
      }

      // 导出多天均值查询结果为Excel
      function exportDailyAveragesData() {
        try {
          console.log("开始导出多天均值数据...");

          // 收集选中的日期
          const selectedCheckboxes = document.querySelectorAll(
            'input[name="selected-dates"]:checked'
          );
          const dates = Array.from(selectedCheckboxes).map((cb) => cb.value);
          console.log("选中的日期:", dates);

          if (dates.length === 0) {
            showAlert("请至少选择一个日期", "warning");
            return;
          }

          // 获取选中的数据类型
          const selectedDataTypeElement = document.querySelector(
            'input[name="data-type"]:checked'
          );
          if (!selectedDataTypeElement) {
            showAlert("请选择数据类型", "warning");
            return;
          }

          const selectedDataType = selectedDataTypeElement.value;
          console.log("选中的数据类型:", selectedDataType);

          // 构造参数
          let url = "/daily-averages/export";

          // 添加查询参数
          const params = new URLSearchParams();
          params.append("dates", JSON.stringify(dates));
          params.append("data_type_keyword", selectedDataType);
          url += "?" + params.toString();
          console.log("导出URL:", url);

          // 显示导出提示
          showAlert("正在导出数据，请稍候...", "info");

          // 禁用导出按钮，防止重复点击
          const exportBtn = document.getElementById("export-btn");
          if (!exportBtn) {
            console.error("未找到导出按钮元素");
            return;
          }

          const originalText = exportBtn.innerHTML;
          exportBtn.disabled = true;
          exportBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 导出中...';

          // 使用fetch API获取文件数据
          fetch(url)
            .then((response) => {
              console.log("收到响应:", response);
              if (!response.ok) {
                return response.json().then((err) => {
                  console.error("服务器返回错误:", err);
                  throw new Error(err.detail || "导出失败");
                });
              }

              // 获取文件名
              const contentDisposition = response.headers.get(
                "Content-Disposition"
              );
              console.log("Content-Disposition header:", contentDisposition);

              let filename = "多天均值数据.xlsx";
              if (contentDisposition) {
                // 处理UTF-8编码的文件名
                const utf8FilenameMatch = contentDisposition.match(
                  /filename\*=UTF-8''(.+)/
                );
                if (utf8FilenameMatch && utf8FilenameMatch[1]) {
                  try {
                    filename = decodeURIComponent(utf8FilenameMatch[1]);
                    console.log("解码后的UTF-8文件名:", filename);
                  } catch (e) {
                    console.error("解码文件名失败:", e);
                    // 回退到基本匹配
                    const basicFilenameMatch =
                      contentDisposition.match(/filename="?([^"]+)"?/);
                    if (basicFilenameMatch && basicFilenameMatch[1]) {
                      filename = basicFilenameMatch[1];
                      console.log("使用基本文件名匹配:", filename);
                    }
                  }
                } else {
                  // 基本的filename匹配
                  const basicFilenameMatch =
                    contentDisposition.match(/filename="?([^"]+)"?/);
                  if (basicFilenameMatch && basicFilenameMatch[1]) {
                    filename = basicFilenameMatch[1];
                    console.log("使用基本文件名匹配:", filename);
                  }
                }
              }
              console.log("最终文件名:", filename);

              // 返回blob格式的响应
              return response.blob().then((blob) => {
                console.log("收到blob数据");
                return { blob, filename };
              });
            })
            .then(({ blob, filename }) => {
              console.log("开始处理下载");
              // 创建下载链接
              const url = window.URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.href = url;
              link.download = filename;

              // 触发下载
              document.body.appendChild(link);
              link.click();

              // 清理
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);

              // 显示成功消息
              showAlert(`文件导出成功: ${filename}`, "success");

              // 恢复导出按钮
              exportBtn.disabled = false;
              exportBtn.innerHTML = originalText;
            })
            .catch((error) => {
              console.error("导出错误:", error);
              showAlert("导出失败: " + error.message, "danger");
              // 恢复导出按钮
              if (exportBtn) {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
              }
            });
        } catch (error) {
          console.error("导出过程中发生错误:", error);
          showAlert("导出失败: " + error.message, "danger");
          // 恢复导出按钮
          const exportBtn = document.getElementById("export-btn");
          if (exportBtn) {
            exportBtn.disabled = false;
            exportBtn.innerHTML = "导出Excel";
          }
        }
      }

      // 显示提示信息
      function showAlert(message, type = "info") {
        // 移除现有的alert
        const existingAlert = document.querySelector(".alert");
        if (existingAlert) {
          existingAlert.remove();
        }

        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;

        const form = document.getElementById("daily-averages-form");
        form.parentNode.insertBefore(alert, form.nextSibling);

        // 3秒后自动移除
        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 3000);
      }
    </script>
  </body>
</html>
