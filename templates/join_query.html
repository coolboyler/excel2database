<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多天均值查询 - Excel2SQL</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --accent-color: #3b82f6;
      --navbar-bg: #2563eb;
      --navbar-text: #ffffff;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --purple-color: #8b5cf6;
      
      /* Layout variables */
      --sidebar-width: 350px;
      --header-height: auto; /* Allow header to grow if needed */
      --border-color: #e5e7eb;
    }

    body {
      background-color: var(--bg-color);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text-primary);
      min-height: 100vh; /* 允许页面自然延伸 */
      display: flex;
      flex-direction: column;
    }

    /* 顶部导航 */
    .navbar {
      background: var(--card-bg);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding-top: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      position: sticky; /* 导航栏吸顶 */
      top: 0;
      z-index: 1020;
    }

    .navbar-brand,
    .navbar-brand:hover {
      color: var(--text-primary);
      font-weight: 800;
      font-size: 1.4rem;
      letter-spacing: -0.025em;
    }

    .navbar-nav {
      gap: 0.75rem;
    }

    .navbar-nav .nav-link {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 1.05rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .navbar-nav .nav-link:hover,
    .navbar-nav .nav-link:focus {
      color: var(--text-primary);
      background-color: rgba(0, 0, 0, 0.08);
    }

    .navbar-nav .nav-link.active {
      color: var(--accent-color);
      font-weight: 700;
      background-color: rgba(59, 130, 246, 0.12);
      border-bottom: 2px solid var(--accent-color);
    }

    /* 主布局容器 */
    .main-container {
      display: flex;
      flex: 1;
      position: relative;
    }

    /* 左侧边栏 */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      flex-shrink: 0;
      /* Sticky Positioning */
      position: sticky;
      top: 76px; /* 紧贴 Navbar 下方 */
      height: calc(100vh - 76px); /* 占满剩余视口高度 */
      overflow-y: auto; /* 允许 Sidebar 自身滚动 */
      z-index: 900;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fcfcfc;
      position: sticky; /* Header 在 Sidebar 内部置顶 */
      top: 0;
      z-index: 10;
    }

    .sidebar-content {
      flex: 1;
      padding: 15px;
      /* 移除内部独立滚动，跟随 Sidebar 滚动 */
      overflow: visible; 
    }

    .sidebar-footer {
      display: none;
    }

    .btn-toolbar {
        min-width: 120px;
    }

    /* 右侧内容区 */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0;
      background: #f8f9fa;
      min-width: 0; /* 防止 flex 子项溢出 */
    }

    /* 右侧顶部工具栏 */
    .content-toolbar {
      padding: 10px 20px;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-start;
      align-items: center;
      flex-shrink: 0;
      height: 60px;
      gap: 20px;
      position: sticky;
      top: 76px; /* 紧贴 sidebar */
      z-index: 910;
    }

    .content-main {
        flex: 1;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        position: relative;
    }

    /* Alert 悬浮样式 */
    #alert-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 2000;
        width: 350px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none; /* 让鼠标穿透容器 */
    }
    
    .alert {
        pointer-events: auto; /* 恢复 alert 的鼠标事件 */
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
        margin-bottom: 0;
        animation: slideInRight 0.3s ease-out;
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* 卡片通用样式 */
    .panel {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    /* 控件样式优化 */
    .form-label {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.4rem;
      color: #374151;
    }

    .control-group {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed var(--border-color);
    }
    .control-group:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    /* 选项卡样式 */
    .nav-pills .nav-link {
      color: #6b7280;
      font-size: 0.85rem;
      padding: 0.3rem 0.6rem;
    }
    .nav-pills .nav-link.active {
      background-color: var(--accent-color);
      color: white;
    }

    /* 日期选择器容器 */
    .date-selector-wrapper {
      background: #f9fafb;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px;
      max-height: 40vh; /* 动态高度，避免占满屏幕 */
      min-height: 150px;
      overflow-y: auto;
    }

    /* 复选框网格 */
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    
    .date-item-label {
      display: flex;
      align-items: center;
      font-size: 0.8rem;
      padding: 3px 6px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .date-item-label:hover {
      border-color: var(--accent-color);
      background: #eff6ff;
    }
    .date-item-label input {
      margin-right: 6px;
    }
    .date-item-label input:checked + span {
      color: var(--accent-color);
      font-weight: 600;
    }

    /* 图表容器自适应 */
    .chart-container {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
      padding: 15px;
      height: 400px; /* 默认高度 */
      min-height: 350px;
      resize: vertical; /* 允许用户调整高度 */
      overflow: hidden;
    }

    /* 表格容器自适应 */
    .table-container-wrapper {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      min-height: 400px; /* 保证有足够空间 */
    }

    .table-responsive {
      flex: 1;
      overflow: auto;
      max-height: 80vh; /* 防止表格无限拉长，保留内部滚动 */
    }

    /* 表格样式 */
    .table thead th {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 10;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .table td {
      font-size: 0.85rem;
      vertical-align: middle;
    }

    /* 按钮样式 */
    .btn-query {
      width: 100%;
      padding: 10px;
      font-weight: 600;
      border-radius: 6px;
    }

    /* 隐藏元素 */
    .hidden {
      display: none !important;
    }

    /* 加载遮罩 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      backdrop-filter: blur(2px);
    }

    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
  </style>
</head>

<body>
  <!-- 顶部导航 -->
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/"><i class="bi bi-grid-1x2-fill"></i> Excel2SQL</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link fw-bold" href="/">首页</a></li>
          <li class="nav-item"><a class="nav-link active fw-bold" href="/join_query">多天均值查询</a></li>
          <li class="nav-item"><a class="nav-link" href="/similar_day">类比日匹配</a></li>
          <li class="nav-item"><a class="nav-link" href="/daily_hourly">分时看板</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 主容器 -->
  <div class="main-container">
    <!-- 左侧操作栏 -->
    <div class="sidebar">
      <div class="sidebar-header">
        <i class="bi bi-sliders"></i> 查询条件
      </div>
      <form id="daily-averages-form" class="d-flex flex-column" onsubmit="executeDailyAveragesQuery(event)">
        <div class="sidebar-content">
          
          <!-- 地区选择 -->
          <div class="control-group">
            <label class="form-label">地区</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="region" id="region-gd" value="广东" checked>
              <label class="btn btn-outline-primary" for="region-gd">广东</label>
              <input type="radio" class="btn-check" name="region" id="region-yn" value="云南">
              <label class="btn btn-outline-primary" for="region-yn">云南</label>
            </div>
          </div>

          <!-- 站点名称 (新增) -->
          <div class="control-group">
            <label class="form-label">站点名称</label>
            <input type="text" class="form-control" id="station-name-input" placeholder="输入站点名称 (留空查均值)">
          </div>

          <!-- 数据类型 -->
          <div class="control-group">
            <label class="form-label">数据类型</label>
            <select class="form-select" name="data-type" id="data-type-select">
              <option value="日前节点电价">日前节点电价</option>
              <option value="实时节点电价">实时节点电价</option>
              <option value="价差查询">价差查询（日前-实时）</option>
            </select>
          </div>

          <!-- 日期筛选方式 -->
          <div class="control-group">
            <label class="form-label">日期筛选</label>
            <ul class="nav nav-pills mb-3" id="filter-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-custom" type="button" onclick="setFilterType('custom')">手动</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-year" type="button" onclick="setFilterType('year')">按年</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-month" type="button" onclick="setFilterType('month')">按月</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-range" type="button" onclick="setFilterType('range')">范围</button>
              </li>
            </ul>
            <input type="hidden" name="filter-type" id="filter-type-input" value="custom">

            <!-- Tab Content -->
            <div class="tab-content">
              <!-- 手动选择 -->
              <div class="tab-pane fade show active" id="tab-custom">
                <div class="row g-2 mb-2">
                  <div class="col-6">
                    <select id="custom-year-select" class="form-select form-select-sm" onchange="initCustomMonthSelect(); updateCustomDateOptions()">
                      <option value="">所有年份</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <select id="custom-month-select" class="form-select form-select-sm" onchange="updateCustomDateOptions()">
                      <option value="">所有月份</option>
                    </select>
                  </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="form-check form-check-sm mb-0">
                    <input class="form-check-input" type="checkbox" id="select-all-dates" onchange="toggleAllDates(this.checked)">
                    <label class="form-check-label" for="select-all-dates">全选当前</label>
                  </div>
                  <small class="text-muted" id="date-count-badge">0个日期</small>
                </div>
                <div id="custom-date-checkboxes" class="date-selector-wrapper checkbox-grid">
                  <!-- 动态生成 -->
                </div>
                <div class="mt-2 text-end">
                   <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllSelectedDates()">清空已选</button>
                </div>
              </div>

              <!-- 按年 -->
              <div class="tab-pane fade" id="tab-year">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="select-all-years" onchange="toggleAllYears(this.checked)">
                  <label class="form-check-label" for="select-all-years">全选年份</label>
                </div>
                <div id="year-selector" class="date-selector-wrapper checkbox-grid">
                   <!-- 动态生成 -->
                </div>
              </div>

              <!-- 按月 -->
              <div class="tab-pane fade" id="tab-month">
                <select id="year-select" class="form-select mb-2" onchange="updateMonthOptions()">
                  <option value="">选择年份</option>
                </select>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="select-all-months" onchange="toggleAllMonths(this.checked)">
                  <label class="form-check-label" for="select-all-months">全选月份</label>
                </div>
                <div id="month-checkboxes" class="date-selector-wrapper checkbox-grid">
                   <!-- 动态生成 -->
                </div>
              </div>

              <!-- 范围 -->
              <div class="tab-pane fade" id="tab-range">
                <div class="mb-3">
                  <label class="form-label small">开始日期</label>
                  <input type="date" id="start-date" class="form-control">
                </div>
                <div class="mb-3">
                  <label class="form-label small">结束日期</label>
                  <input type="date" id="end-date" class="form-control">
                </div>
                <button type="button" class="btn btn-sm btn-secondary w-100" onclick="applyDateRange()">确认范围</button>
                <div id="range-info" class="mt-2 small text-success"></div>
              </div>
            </div>
          </div>

        </div>
        
        <!-- Sidebar Footer Removed -->
      </form>
    </div>

    <!-- 右侧展示区 -->
    <div class="content-area">
      <!-- 顶部工具栏 -->
      <div class="content-toolbar">
        <div class="btn-toolbar d-flex gap-2">
           <button type="submit" form="daily-averages-form" class="btn btn-primary btn-sm shadow-sm px-3">
             <i class="bi bi-search"></i> 开始查询
           </button>
           <button type="button" class="btn btn-success btn-sm shadow-sm hidden px-3" id="export-btn" onclick="exportDailyAveragesData()">
             <i class="bi bi-file-earmark-excel"></i> 导出Excel
           </button>
           <button type="button" class="btn btn-info btn-sm shadow-sm px-3" id="export-cache-btn" onclick="exportCacheData()" title="导出选中日期的日前、实时对比数据（带颜色样式）">
             <i class="bi bi-database-export"></i> 导出日前-实时对比
           </button>
           <button type="button" class="btn btn-warning btn-sm shadow-sm px-3" id="export-ne-btn" onclick="exportNewEnergyForecast()" title="导出选中日期的新能源D日预测（从缓存表查询）">
             <i class="bi bi-file-earmark-excel"></i> 导出新能源D日预测
           </button>
        </div>
        <div class="vr opacity-25"></div>
        <div id="selected-count-info" class="text-secondary small fw-bold">已选择 0 个日期</div>
      </div>
      
      <!-- Alert 容器 (Fixed Position) -->
      <div id="alert-container"></div>

      <div class="content-main">

      <!-- 图表区域 -->
      <div class="panel chart-container hidden" id="chart-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-2" style="height: 30px;">
          <h5 class="m-0 fw-bold text-secondary"><i class="bi bi-graph-up"></i> 数据趋势</h5>
          <div class="d-flex gap-2 align-items-center">
            <div class="form-check form-switch mb-0">
              <input class="form-check-input" type="checkbox" id="show-labels" onchange="renderChart()">
              <label class="form-check-label small" for="show-labels">数值</label>
            </div>
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-outline-secondary active" onclick="switchViewMode('daily')" id="btn-view-daily">按日</button>
              <button type="button" class="btn btn-outline-secondary" onclick="switchViewMode('weekly')" id="btn-view-weekly">按周</button>
            </div>
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-outline-secondary active" onclick="switchChartType('line')" id="btn-chart-line">折线</button>
              <button type="button" class="btn btn-outline-secondary" onclick="switchChartType('bar')" id="btn-chart-bar">柱状</button>
            </div>
          </div>
        </div>
        <div id="main-chart" style="width: 100%; height: calc(100% - 30px);"></div>
      </div>

      <!-- 表格区域 -->
      <div class="panel table-container-wrapper hidden" id="result-section">
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
          <span id="result-info" class="fw-bold text-dark small">查询结果</span>
          <div id="pagination" class="d-flex gap-1"></div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="bg-light">
              <tr id="result-header"></tr>
            </thead>
            <tbody id="result-body"></tbody>
          </table>
        </div>
      </div>
      
      <!-- 初始状态 -->
      <div id="empty-state" class="d-flex flex-column justify-content-center align-items-center h-100 text-muted" style="background: radial-gradient(circle at center, #f8f9fa 0%, #fff 70%);">
        <div class="mb-4 position-relative">
          <i class="bi bi-grid-1x2 text-primary" style="font-size: 5rem; opacity: 0.2;"></i>
          <i class="bi bi-search position-absolute bottom-0 end-0 text-success" style="font-size: 2.5rem; transform: translate(20%, 20%); opacity: 0.8;"></i>
        </div>
        <h4 class="fw-light mb-3 text-dark">开始数据探索</h4>
        <div class="d-flex gap-4 text-secondary small">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-calendar-check text-primary"></i>
            <span>选择日期</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-lightning text-warning"></i>
            <span>选择数据类型</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-bar-chart text-success"></i>
            <span>生成可视化图表</span>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- 加载遮罩 -->
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <h5 class="text-dark fw-bold" id="loading-text">正在处理...</h5>
    <p class="text-muted small">数据量较大时可能需要几十秒，请耐心等待</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script>
    // 全局变量
    let queryResult = [];
    let currentPage = 1;
    const itemsPerPage = 50; // 增加每页显示数量
    let chartInstance = null;
    let availableDates = []; // 存储所有可用日期对象 {date, year, month, table}
    let manuallySelectedDates = new Set(); // 存储手动选中的日期字符串
    let selectedDateRange = null; // 存储日期范围
    let currentFilterType = 'custom'; // custom, year, month, range

    // 排序状态
    let currentSort = {
      field: 'record_date',
      direction: 'desc'
    };

    // 初始化
    document.addEventListener("DOMContentLoaded", function () {
      loadTableList();
      
      // 窗口大小改变时调整图表
      window.addEventListener('resize', function() {
        if (chartInstance) {
          chartInstance.resize();
        }
      });
    });

    // 切换筛选类型
    function setFilterType(type) {
      currentFilterType = type;
      document.getElementById('filter-type-input').value = type;
      updateSelectedCountInfo();
    }

    // 显示/隐藏加载遮罩
    function toggleLoading(show, text = "正在处理...") {
      const overlay = document.getElementById('loading-overlay');
      const loadingText = document.getElementById('loading-text');
      if (show) {
        loadingText.textContent = text;
        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
    }

    // 加载表列表
    function loadTableList() {
      fetch("/tables")
        .then((response) => response.json())
        .then((data) => {
          processAvailableDates(data.tables);
          initSelectors();
        })
        .catch((error) => {
          showAlert("加载表列表失败: " + error.message, "error");
        });
    }

    // 处理日期数据
    function processAvailableDates(tables) {
      availableDates = [];
      tables.forEach((table) => {
        const match = table.match(/^power_data_(\d{8})$/);
        if (match) {
          const dateStr = match[1];
          const year = dateStr.substring(0, 4);
          const month = dateStr.substring(4, 6);
          const day = dateStr.substring(6, 8);
          availableDates.push({
            table: table,
            date: `${year}-${month}-${day}`,
            year: year,
            month: month,
            day: day,
          });
        }
      });
      // 默认按日期倒序
      availableDates.sort((a, b) => b.date.localeCompare(a.date));
    }

    // 初始化各个选择器
    function initSelectors() {
      if (!availableDates.length) return;

      const years = [...new Set(availableDates.map(d => d.year))].sort((a, b) => b - a);

      // 1. 初始化年份下拉框 (手动选择 & 按月筛选)
      const customYearSelect = document.getElementById("custom-year-select");
      const yearSelect = document.getElementById("year-select"); // 按月筛选用
      
      // 清空
      customYearSelect.innerHTML = '<option value="">所有年份</option>';
      yearSelect.innerHTML = '<option value="">选择年份</option>';

      years.forEach(year => {
        // 手动选择用的下拉
        const opt1 = document.createElement("option");
        opt1.value = year;
        opt1.textContent = year + "年";
        customYearSelect.appendChild(opt1);

        // 按月筛选用的下拉
        const opt2 = document.createElement("option");
        opt2.value = year;
        opt2.textContent = year + "年";
        yearSelect.appendChild(opt2);
      });

      // 2. 初始化手动选择区域 (默认显示最新年份的数据，或者全部)
      // 为了性能，默认只显示最新年份的数据
      if (years.length > 0) {
        customYearSelect.value = years[0];
        yearSelect.value = years[0];
      }
      initCustomMonthSelect(); // 初始化手动选择的月份下拉框
      updateCustomDateOptions();
      updateMonthOptions(); // 初始化按月筛选的月份列表

      // 3. 初始化按年筛选的复选框
      const yearSelector = document.getElementById("year-selector");
      const yearFragment = document.createDocumentFragment();
      years.forEach(year => {
        const label = document.createElement("label");
        label.className = "date-item-label";
        label.innerHTML = `<input type="checkbox" name="selected-years" value="${year}" onchange="updateSelectedCountInfo()"> <span>${year}</span>`;
        yearFragment.appendChild(label);
      });
      yearSelector.innerHTML = "";
      yearSelector.appendChild(yearFragment);
    }

    // 初始化手动选择的月份下拉框
    function initCustomMonthSelect() {
      const year = document.getElementById("custom-year-select").value;
      const monthSelect = document.getElementById("custom-month-select");
      const currentVal = monthSelect.value;
      
      monthSelect.innerHTML = '<option value="">所有月份</option>';
      
      if (!year) return; 
      
      // 获取该年份下有的月份
      const months = [...new Set(availableDates.filter(d => d.year === year).map(d => d.month))].sort();
      
      months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m + "月";
        monthSelect.appendChild(opt);
      });
      
      // 尝试恢复选择 (如果切换年份后，之前选的月份在新年份也存在，则保持)
      if (currentVal && months.includes(currentVal)) {
          monthSelect.value = currentVal;
      }
    }

    // 更新手动选择区域的日期列表 (使用 DocumentFragment 优化性能)
    function updateCustomDateOptions() {
      // 确保月份下拉框与年份同步
      // 注意：如果是 custom-year-select 触发的 change，需要先更新 month select
      // 但这里我们简单处理：每次 updateCustomDateOptions 前，检查是否需要重新初始化 month select
      // 或者更直接地，在 year select 的 onchange 事件中显式调用 initCustomMonthSelect
      
      const year = document.getElementById("custom-year-select").value;
      const month = document.getElementById("custom-month-select").value;
      const container = document.getElementById("custom-date-checkboxes");
      
      // 筛选
      let filtered = availableDates;
      if (year) filtered = filtered.filter(d => d.year === year);
      if (month) filtered = filtered.filter(d => d.month === month);

      document.getElementById('date-count-badge').textContent = `${filtered.length}个日期`;

      // 使用 Fragment 构建 DOM
      const fragment = document.createDocumentFragment();
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-muted small p-2">无数据</div>';
        return;
      }

      // 限制渲染数量，防止 DOM 过多卡顿 (如果超过 500 个，提示先筛选)
      if (filtered.length > 500) {
        container.innerHTML = '<div class="alert alert-warning small p-2 m-0" style="grid-column: 1/-1">数据过多，请先选择年份或月份进行筛选</div>';
        return;
      }

      filtered.forEach(d => {
        const label = document.createElement("label");
        label.className = "date-item-label";
        const isChecked = manuallySelectedDates.has(d.date) ? "checked" : "";
        label.innerHTML = `
          <input type="checkbox" name="selected-dates" value="${d.date}" ${isChecked} onchange="onDateCheckChange(this)">
          <span>${d.date}</span>
        `;
        fragment.appendChild(label);
      });

      container.innerHTML = "";
      container.appendChild(fragment);
      updateSelectAllState();
    }

    // 单个日期勾选变化
    function onDateCheckChange(checkbox) {
      if (checkbox.checked) {
        manuallySelectedDates.add(checkbox.value);
      } else {
        manuallySelectedDates.delete(checkbox.value);
      }
      updateSelectedCountInfo();
      updateSelectAllState();
    }

    // 更新"全选当前"复选框状态
    function updateSelectAllState() {
      const checkboxes = document.querySelectorAll('input[name="selected-dates"]');
      if (checkboxes.length === 0) return;
      
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      const someChecked = Array.from(checkboxes).some(cb => cb.checked);
      
      const selectAll = document.getElementById("select-all-dates");
      selectAll.checked = allChecked;
      selectAll.indeterminate = someChecked && !allChecked;
    }

    // 全选/取消全选当前显示的日期
    function toggleAllDates(checked) {
      const checkboxes = document.querySelectorAll('input[name="selected-dates"]');
      checkboxes.forEach(cb => {
        cb.checked = checked;
        if (checked) {
          manuallySelectedDates.add(cb.value);
        } else {
          manuallySelectedDates.delete(cb.value);
        }
      });
      updateSelectedCountInfo();
    }

    // 清空所有已选
    function clearAllSelectedDates() {
      manuallySelectedDates.clear();
      // 更新当前显示的 checkbox
      const checkboxes = document.querySelectorAll('input[name="selected-dates"]');
      checkboxes.forEach(cb => cb.checked = false);
      updateSelectedCountInfo();
      updateSelectAllState();
    }

    // 更新底部已选数量提示
    function updateSelectedCountInfo() {
      let text = "请选择日期";
      
      if (currentFilterType === 'custom') {
         const count = manuallySelectedDates.size;
         text = `已手动选择 ${count} 个日期`;
      } 
      else if (currentFilterType === 'year') {
         const count = document.querySelectorAll('input[name="selected-years"]:checked').length;
         text = count > 0 ? `已选择 ${count} 个年份` : "请勾选年份";
      } 
      else if (currentFilterType === 'month') {
         const count = document.querySelectorAll('input[name="selected-months"]:checked').length;
         text = count > 0 ? `已选择 ${count} 个月份` : "请勾选月份";
      } 
      else if (currentFilterType === 'range') {
         text = selectedDateRange ? `${selectedDateRange.start} 至 ${selectedDateRange.end}` : "请设定范围";
      }
      
      document.getElementById("selected-count-info").textContent = text;
    }

    // 更新按月筛选的月份列表
    function updateMonthOptions() {
      const year = document.getElementById("year-select").value;
      const container = document.getElementById("month-checkboxes");
      container.innerHTML = "";

      if (!year) return;

      const months = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
      const fragment = document.createDocumentFragment();

      months.forEach(m => {
        // 检查该月是否有数据
        const hasData = availableDates.some(d => d.year === year && d.month === m);
        if (hasData) {
          const label = document.createElement("label");
          label.className = "date-item-label";
          label.innerHTML = `<input type="checkbox" name="selected-months" value="${m}" onchange="updateSelectedCountInfo()"> <span>${m}月</span>`;
          fragment.appendChild(label);
        }
      });
      container.appendChild(fragment);
      updateSelectedCountInfo(); // Update info when options change
    }

    // 全选年份
    function toggleAllYears(checked) {
      document.querySelectorAll('input[name="selected-years"]').forEach(cb => cb.checked = checked);
      updateSelectedCountInfo();
    }
    // 全选月份
    function toggleAllMonths(checked) {
      document.querySelectorAll('input[name="selected-months"]').forEach(cb => cb.checked = checked);
      updateSelectedCountInfo();
    }

    // 应用日期范围
    function applyDateRange() {
      const start = document.getElementById("start-date").value;
      const end = document.getElementById("end-date").value;
      if (!start || !end) {
        showAlert("请选择开始和结束日期", "warning");
        return;
      }
      if (start > end) {
        showAlert("开始日期不能晚于结束日期", "warning");
        return;
      }
      selectedDateRange = { start, end };
      document.getElementById("range-info").textContent = `已选范围: ${start} 至 ${end}`;
      updateSelectedCountInfo();
    }

    // 执行查询
    function executeDailyAveragesQuery(event) {
      event.preventDefault();

      // 收集参数
      const region = document.querySelector('input[name="region"]:checked').value;
      const dataTypeFull = document.getElementById("data-type-select").value;
      const stationName = document.getElementById("station-name-input").value;
      let dates = [];

      // 根据当前模式收集日期
      if (currentFilterType === 'custom') {
        if (manuallySelectedDates.size === 0) {
          showAlert("请至少选择一个日期", "warning");
          return;
        }
        dates = Array.from(manuallySelectedDates);
      } else if (currentFilterType === 'year') {
        const years = Array.from(document.querySelectorAll('input[name="selected-years"]:checked')).map(cb => cb.value);
        if (years.length === 0) {
          showAlert("请选择年份", "warning");
          return;
        }
        dates = availableDates.filter(d => years.includes(d.year)).map(d => d.date);
      } else if (currentFilterType === 'month') {
        const year = document.getElementById("year-select").value;
        const months = Array.from(document.querySelectorAll('input[name="selected-months"]:checked')).map(cb => cb.value);
        if (!year || months.length === 0) {
          showAlert("请选择年份和月份", "warning");
          return;
        }
        dates = availableDates.filter(d => d.year === year && months.includes(d.month)).map(d => d.date);
      } else if (currentFilterType === 'range') {
        if (!selectedDateRange) {
          showAlert("请先确认日期范围", "warning");
          return;
        }
        dates = availableDates.filter(d => d.date >= selectedDateRange.start && d.date <= selectedDateRange.end).map(d => d.date);
      }

      if (dates.length === 0) {
        showAlert("所选范围内没有数据", "warning");
        return;
      }

      // 准备 API 参数
      const isPriceDifference = dataTypeFull === "价差查询";
      let dataTypeKeyword = dataTypeFull;
      if (!isPriceDifference && !dataTypeFull.startsWith(region)) {
        dataTypeKeyword = region + "_" + dataTypeFull;
      }
      const regionPrefix = region ? region + "_" : "";

      // UI 状态
      toggleLoading(true, "正在查询数据...");
      document.getElementById("empty-state").classList.add("hidden");
      document.getElementById("chart-wrapper").classList.add("hidden");
      document.getElementById("result-section").classList.add("hidden");

      const formData = new FormData();
      formData.append("dates", JSON.stringify(dates));
      if (stationName && stationName.trim()) {
        formData.append("station_name", stationName.trim());
      }
      
      let apiUrl;
      if (isPriceDifference) {
        formData.append("region", regionPrefix);
        apiUrl = "/price-difference";
      } else {
        formData.append("data_type_keyword", dataTypeKeyword);
        apiUrl = "/daily-averages";
      }

      // 请求
      fetch(apiUrl, {
        method: "POST",
        body: formData,
      })
      .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.detail || "查询失败") }))
      .then(data => {
        toggleLoading(false);
        handleQuerySuccess(data, isPriceDifference);
      })
      .catch(err => {
        toggleLoading(false);
        showAlert(err.message, "error");
        document.getElementById("export-btn").classList.add("hidden");
      });
    }

    // 处理查询成功
    function handleQuerySuccess(data, isPriceDifference) {
      queryResult = data.data || [];
      
      if (queryResult.length === 0) {
        showAlert("未找到匹配数据", "warning");
        document.getElementById("chart-wrapper").classList.add("hidden");
        document.getElementById("result-section").classList.add("hidden");
        document.getElementById("export-btn").classList.add("hidden");
        document.getElementById("empty-state").classList.remove("hidden");
        return;
      }

      // 重置排序
      currentSort = { field: 'record_date', direction: 'desc' };
      
      // 显示区域
      document.getElementById("chart-wrapper").classList.remove("hidden");
      document.getElementById("result-section").classList.remove("hidden");
      document.getElementById("export-btn").classList.remove("hidden");
      document.getElementById("empty-state").classList.add("hidden"); // Ensure empty state is hidden
      
      // 渲染
      renderChart();
      currentPage = 1;
      renderTable();
      
      showAlert(`查询成功，共 ${data.total} 条记录`, "success");
    }

    // 渲染表格
    function renderTable() {
      if (!queryResult.length) return;

      const thead = document.getElementById("result-header");
      const tbody = document.getElementById("result-body");
      
      // 表头 (仅在第一次或列变化时生成，这里简化为每次生成)
      const keys = Object.keys(queryResult[0]).filter(k => k !== 'sheet_name');
      thead.innerHTML = "";
      keys.forEach(k => {
        const th = document.createElement("th");
        th.textContent = k;
        th.style.cursor = "pointer";
        th.onclick = () => toggleSort(k);
        thead.appendChild(th);
      });

      // 数据分页
      tbody.innerHTML = "";
      const start = (currentPage - 1) * itemsPerPage;
      const end = Math.min(start + itemsPerPage, queryResult.length);
      const pageData = queryResult.slice(start, end);

      const fragment = document.createDocumentFragment();
      pageData.forEach(row => {
        const tr = document.createElement("tr");
        keys.forEach(k => {
          const td = document.createElement("td");
          td.textContent = formatCellValue(k, row[k]);
          tr.appendChild(td);
        });
        fragment.appendChild(tr);
      });
      tbody.appendChild(fragment);

      // 分页控件
      renderPagination();
      
      // 更新信息
      const sortStr = currentSort.direction === 'asc' ? '正序' : '倒序';
      document.getElementById("result-info").textContent = `共 ${queryResult.length} 条 | 第 ${currentPage}/${Math.ceil(queryResult.length/itemsPerPage)} 页 | ${sortStr}`;
    }

    // 单元格格式化
    function formatCellValue(key, value) {
      if (value === null || value === undefined) return "";
      if (key === "record_time") {
        // 尝试解析时间
        if (typeof value === 'object' && value.seconds !== undefined) {
           const h = Math.floor(value.seconds / 3600);
           const m = Math.floor((value.seconds % 3600) / 60);
           return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        }
        if (typeof value === 'number') { // 假设是秒
           const h = Math.floor(value / 3600);
           const m = Math.floor((value % 3600) / 60);
           return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        }
      }
      return value;
    }

    // 排序逻辑
    function toggleSort(field) {
      if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.field = field;
        currentSort.direction = 'desc';
      }
      
      queryResult.sort((a, b) => {
        let valA = a[field];
        let valB = b[field];
        if (valA === null || valA === undefined) valA = "";
        if (valB === null || valB === undefined) valB = "";

        // 数字比较
        const numA = parseFloat(valA);
        const numB = parseFloat(valB);
        if (!isNaN(numA) && !isNaN(numB) && isFinite(valA) && isFinite(valB)) {
           return currentSort.direction === 'asc' ? numA - numB : numB - numA;
        }
        // 字符串比较
        return currentSort.direction === 'asc' 
          ? String(valA).localeCompare(String(valB))
          : String(valB).localeCompare(String(valA));
      });
      
      currentPage = 1;
      renderTable();
    }

    // 分页控件
    function renderPagination() {
      const container = document.getElementById("pagination");
      container.innerHTML = "";
      const totalPages = Math.ceil(queryResult.length / itemsPerPage);
      if (totalPages <= 1) return;

      const createBtn = (text, page, disabled = false, active = false) => {
        const btn = document.createElement("button");
        btn.className = `btn btn-sm ${active ? 'btn-primary' : 'btn-outline-secondary'}`;
        btn.textContent = text;
        btn.disabled = disabled;
        btn.onclick = () => {
          currentPage = page;
          renderTable();
        };
        return btn;
      };

      container.appendChild(createBtn("首页", 1, currentPage === 1));
      container.appendChild(createBtn("上一页", currentPage - 1, currentPage === 1));
      
      // 简化的页码显示：当前页
      const span = document.createElement("span");
      span.className = "px-2 d-flex align-items-center small";
      span.textContent = `${currentPage} / ${totalPages}`;
      container.appendChild(span);

      container.appendChild(createBtn("下一页", currentPage + 1, currentPage === totalPages));
      container.appendChild(createBtn("末页", totalPages, currentPage === totalPages));
    }

    // 图表渲染 (优化内存)
    let currentChartType = 'line';
    let currentViewMode = 'daily';

    function switchChartType(type) {
      currentChartType = type;
      document.getElementById('btn-chart-line').classList.toggle('active', type === 'line');
      document.getElementById('btn-chart-bar').classList.toggle('active', type === 'bar');
      renderChart();
    }
    
    function switchViewMode(mode) {
      currentViewMode = mode;
      document.getElementById('btn-view-daily').classList.toggle('active', mode === 'daily');
      document.getElementById('btn-view-weekly').classList.toggle('active', mode === 'weekly');
      renderChart();
    }

    function renderChart() {
      const chartDom = document.getElementById('main-chart');
      if (!queryResult.length) return;

      // 1. 销毁旧实例或清空，防止内存泄漏
      if (chartInstance) {
        chartInstance.clear(); // 清空当前实例数据
      } else {
        chartInstance = echarts.init(chartDom);
      }

      // 2. 处理数据
      // 这里的逻辑复用原有的数据处理逻辑，但进行简化和性能优化
      // 提取 hours 0-23
      const hours = Array.from({length: 24}, (_, i) => `${String(i).padStart(2,'0')}:00`);
      
      // 归一化 record_time 到 0-23
      const getHour = (val) => {
         if (val === null || val === undefined) return -1;
         
         // 处理对象 (timedelta)
         if (typeof val === 'object' && val.seconds !== undefined) return Math.floor(val.seconds / 3600);
         
         // 处理数字
         if (typeof val === 'number') {
             if (val >= 0 && val < 24) return val; // 0-23
             if (val >= 100 && val <= 2400) return Math.floor(val / 100); // 0900 -> 9
             return Math.floor(val / 3600); // seconds
         }
         
         // 处理字符串
         if (typeof val === 'string') {
             const s = val.trim();
             if (s.includes(':')) return parseInt(s.split(':')[0]);
             const n = parseInt(s);
             if (!isNaN(n)) {
                 if (n >= 0 && n < 24) return n;
                 if (n >= 100 && n <= 2400) return Math.floor(n / 100);
                 return Math.floor(n / 3600);
             }
         }
         return -1;
      };

      // 分组
      const seriesData = {}; // key -> [24 values]
      
      queryResult.forEach(item => {
        let key = item.record_date;
        if (!key) return;
        
        // 如果是按周模式，计算周
        if (currentViewMode === 'weekly') {
           const d = new Date(key);
           // 简单周计算
           const onejan = new Date(d.getFullYear(), 0, 1);
           const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
           key = `${d.getFullYear()}年第${week}周`;
        }

        if (!seriesData[key]) seriesData[key] = new Array(24).fill(null).map(() => []);
        
        const h = getHour(item.record_time);
        if (h >= 0 && h < 24) {
           seriesData[key][h].push(parseFloat(item.value));
        }
      });

      // 计算平均值
      const series = [];
      const legendData = [];
      
      // 限制显示的系列数量，防止浏览器崩溃 (最多显示前 50 条线)
      const keys = Object.keys(seriesData).sort();
      const displayKeys = keys.slice(0, 50); 
      
      displayKeys.forEach(key => {
         const data = seriesData[key].map(vals => {
            if (vals.length === 0) return null;
            return parseFloat((vals.reduce((a,b)=>a+b,0) / vals.length).toFixed(2));
         });
         
         series.push({
           name: key,
           type: currentChartType,
           data: data,
           smooth: true,
           symbol: 'none', // 减少渲染点，提升性能
           lineStyle: { width: 2 }
         });
         legendData.push(key);
      });

      if (keys.length > 50) {
        showAlert(`数据量过大 (${keys.length}条)，图表仅显示前50条数据`, "warning");
      }

      const showLabels = document.getElementById('show-labels').checked;
      if (showLabels) {
        series.forEach(s => s.label = { show: true, position: 'top' });
      }

      const option = {
        tooltip: { trigger: 'axis' },
        legend: { data: legendData, type: 'scroll', bottom: 0 },
        grid: { left: '3%', right: '4%', bottom: '10%', top: '10%', containLabel: true },
        xAxis: { type: 'category', data: hours },
        yAxis: { type: 'value', scale: true },
        series: series
      };

      chartInstance.setOption(option);
    }

    // 导出功能
    function exportDailyAveragesData() {
       // 复用原有导出逻辑，但获取参数方式调整
       // ... (这里代码较长，且逻辑主要是构造 FormData 和下载，基本不变)
       // 为了简洁，直接调用原有逻辑的精简版
       
       const btn = document.getElementById("export-btn");
       const originalText = btn.innerHTML;
       btn.disabled = true;
       btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 导出中...';

       const region = document.querySelector('input[name="region"]:checked').value;
       const dataTypeFull = document.getElementById("data-type-select").value;
       const isPriceDifference = dataTypeFull === "价差查询";
       let dataTypeKeyword = dataTypeFull;
       if (!isPriceDifference && !dataTypeFull.startsWith(region)) {
         dataTypeKeyword = region + "_" + dataTypeFull;
       }
       const regionPrefix = region ? region + "_" : "";

       const formData = new FormData();
       formData.append("query_result", JSON.stringify(queryResult));
       if (isPriceDifference) {
         formData.append("region", regionPrefix);
       } else {
         formData.append("data_type_keyword", dataTypeKeyword);
       }

       const apiUrl = isPriceDifference ? "/price-difference/export-from-result" : "/daily-averages/export-from-result";

       fetch(apiUrl, { method: "POST", body: formData })
         .then(res => {
            if (res.ok) return res.blob().then(blob => ({ blob, filename: "export.xlsx" })); // 简化文件名获取
            throw new Error("导出失败");
         })
         .then(({blob, filename}) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `多天均值数据_${new Date().getTime()}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showAlert("导出成功", "success");
         })
         .catch(err => showAlert(err.message, "error"))
         .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
         });
    }

    // 导出缓存数据（日前、实时、均值对比）
    function exportCacheData() {
       const btn = document.getElementById("export-cache-btn");
       const originalText = btn.innerHTML;
       btn.disabled = true;
       btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 导出中...';

       // 获取选中的日期
       const dates = Array.from(manuallySelectedDates);
       if (dates.length === 0) {
         showAlert("请先选择日期", "warning");
         btn.disabled = false;
         btn.innerHTML = originalText;
         return;
       }

       const formData = new FormData();
       formData.append("dates", JSON.stringify(dates));

       // 调用新的日前实时均值对比导出接口
       fetch("/api/daily-averages/export-dr-compare", { method: "POST", body: formData })
         .then(res => {
            if (res.ok) return res.blob();
            throw new Error("导出失败");
         })
         .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `日前实时对比_${new Date().getTime()}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showAlert("导出成功", "success");
         })
         .catch(err => showAlert(err.message, "error"))
         .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
         });
    }

    // 导出新能源D日预测（从缓存表查询）
    function exportNewEnergyForecast() {
       const btn = document.getElementById("export-ne-btn");
       const originalText = btn.innerHTML;
       btn.disabled = true;
       btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 导出中...';

       const dates = Array.from(manuallySelectedDates);
       if (dates.length === 0) {
         showAlert("请先选择日期", "warning");
         btn.disabled = false;
         btn.innerHTML = originalText;
         return;
       }

       const formData = new FormData();
       formData.append("dates", JSON.stringify(dates));

       fetch("/api/daily-averages/export-new-energy-forecast", { method: "POST", body: formData })
         .then(res => {
            if (res.ok) return res.blob();
            return res.json().then(j => { throw new Error(j.error || "导出失败"); });
         })
         .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `新能源D日预测_${new Date().getTime()}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showAlert("导出成功", "success");
         })
         .catch(err => showAlert(err.message, "error"))
         .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
         });
    }

    // 提示框
    function showAlert(msg, type) {
      const container = document.getElementById("alert-container");
      const alert = document.createElement("div");
      alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show py-2 small shadow-sm`;
      alert.innerHTML = `
        ${msg}
        <button type="button" class="btn-close py-2" data-bs-dismiss="alert"></button>
      `;
      container.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }

  </script>
</body>
</html>
