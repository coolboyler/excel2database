<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>多天均值查询 - Excel2SQL</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }

      .btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn:hover {
        background-color: #2980b9;
      }

      .btn-primary {
        background-color: #3498db;
      }

      .btn-primary:hover {
        background-color: #2980b9;
      }

      .result-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .result-table th,
      .result-table td {
        border: 1px solid #ddd;
        padding: 8px 12px;
        text-align: left;
      }

      .result-table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      .result-table tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      .alert {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .pagination button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background-color: white;
        cursor: pointer;
        border-radius: 4px;
      }

      .pagination button:hover {
        background-color: #f8f9fa;
      }

      .pagination button.active {
        background-color: #3498db;
        color: white;
      }

      .query-result-info {
        margin: 15px 0;
        font-weight: 500;
      }

      .hidden {
        display: none;
      }

      .sql-editor {
        width: 100%;
        min-height: 150px;
        font-family: monospace;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }

      /* 为表格容器添加滚动条 */
      .table-container {
        overflow-x: auto;
        max-width: 100%;
        margin: 10px 0;
      }

      .table-container table {
        min-width: 100%;
      }

      /* 日期选择器样式 */
      .year-month-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      .year-month-selector select {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .select-all-row {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
      }

      .select-all-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        cursor: pointer;
      }

      .select-all-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .checkboxes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 8px;
      }

      .date-option label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        padding: 6px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .date-option label:hover {
        background-color: #f5f5f5;
      }

      .date-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }

      .select-all-container {
        margin-top: 10px;
      }

      .select-all-container .btn {
        padding: 6px 12px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>多天均值查询</h1>
        <div>
          <a href="/" class="btn">返回首页</a>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="card">
        <form id="daily-averages-form">
          <div class="form-group">
            <label for="data-type-keyword">数据类型关键字:</label>
            <input
              type="text"
              id="data-type-keyword"
              value="日前节点电价"
              placeholder="例如: 日前节点电价"
            />
          </div>

          <div class="form-group">
            <label>选择日期:</label>
            <div class="year-month-selector">
              <select id="year-select" onchange="populateYearMonthOptions()">
                <option value="">选择年份</option>
              </select>
              <select id="month-select" onchange="updateDateOptions()">
                <option value="">选择月份</option>
              </select>
            </div>
            <div
              id="date-checkboxes"
              style="
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid #ddd;
                padding: 10px;
                margin-top: 10px;
              "
            >
              <!-- 日期复选框将在这里动态生成 -->
              <div
                id="no-dates-message"
                style="
                  text-align: center;
                  color: #666;
                  padding: 20px;
                  display: none;
                "
              >
                暂无可用日期数据
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">查询均值</button>
        </form>
      </div>

      <!-- 查询结果 -->
      <div class="card hidden" id="result-section">
        <h2>查询结果</h2>
        <div class="query-result-info" id="result-info"></div>
        <div class="table-container">
          <table class="result-table" id="result-table">
            <thead>
              <tr id="result-header"></tr>
            </thead>
            <tbody id="result-body"></tbody>
          </table>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>

    <footer>
      <div class="container">
        <p>Excel2SQL - 数据导入工具 &copy; 2025</p>
      </div>
    </footer>

    <script>
      let queryResult = [];
      let currentPage = 1;
      const itemsPerPage = 20;
      let selectedTables = [];

      // 页面加载完成后初始化
      document.addEventListener("DOMContentLoaded", function () {
        loadTableList();
        document
          .getElementById("daily-averages-form")
          .addEventListener("submit", executeDailyAveragesQuery);
      });

      // 加载表列表
      function loadTableList() {
        fetch("/tables")
          .then((response) => response.json())
          .then((data) => {
            // 为多天均值查询准备日期选项
            populateDateOptions(data.tables);
            populateYearMonthOptions();
          })
          .catch((error) => {
            showAlert("加载表列表失败: " + error.message, "error");
          });
      }

      // 为多天均值查询填充日期选项
      function populateDateOptions(tables) {
        // 从表名中提取日期信息
        const dates = [];
        tables.forEach((table) => {
          // 匹配 power_data_YYYYMMDD 格式的表名
          const match = table.match(/^power_data_(\d{8})$/);
          if (match) {
            const dateStr = match[1];
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            dates.push({
              table: table,
              date: `${year}-${month}-${day}`,
              year: year,
              month: month,
              day: day,
            });
          }
        });

        // 保存日期信息供后续使用
        window.availableDates = dates;
      }

      // 添加年份和月份选项
      function populateYearMonthOptions() {
        if (!window.availableDates) return;

        const years = [
          ...new Set(window.availableDates.map((d) => d.year)),
        ].sort((a, b) => b - a);
        const months = [
          ...new Set(window.availableDates.map((d) => d.month)),
        ].sort();

        const yearSelect = document.getElementById("year-select");
        const monthSelect = document.getElementById("month-select");

        // 保存当前选择
        const currentYear = yearSelect.value;
        const currentMonth = monthSelect.value;

        // 填充年份选项
        yearSelect.innerHTML = '<option value="">选择年份</option>';
        years.forEach((year) => {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });

        // 恢复当前选择
        if (currentYear) {
          yearSelect.value = currentYear;
        }

        // 填充月份选项
        monthSelect.innerHTML = '<option value="">选择月份</option>';
        months.forEach((month) => {
          const option = document.createElement("option");
          option.value = month;
          option.textContent = month;
          monthSelect.appendChild(option);
        });

        // 恢复当前选择
        if (currentMonth) {
          monthSelect.value = currentMonth;
        }
      }

      // 根据选择的年份和月份更新日期选项
      function updateDateOptions() {
        const yearSelect = document.getElementById("year-select");
        const monthSelect = document.getElementById("month-select");
        const year = yearSelect.value;
        const month = monthSelect.value;

        const dateCheckboxes = document.getElementById("date-checkboxes");
        const noDatesMessage = document.getElementById("no-dates-message");

        // 清空现有内容
        dateCheckboxes.innerHTML = "";

        if (!year || !month || !window.availableDates) {
          // 显示无数据提示
          noDatesMessage.style.display = "block";
          dateCheckboxes.appendChild(noDatesMessage);
          return;
        }

        // 筛选匹配的日期
        const filteredDates = window.availableDates.filter(
          (d) => d.year === year && d.month === month
        );

        if (filteredDates.length === 0) {
          // 显示无数据提示
          noDatesMessage.style.display = "block";
          dateCheckboxes.appendChild(noDatesMessage);
          return;
        }

        // 隐藏无数据提示
        noDatesMessage.style.display = "none";

        // 创建全选行
        const selectAllDiv = document.createElement("div");
        selectAllDiv.className = "select-all-row";
        selectAllDiv.innerHTML = `
          <label class="select-all-label">
            <input type="checkbox" id="select-all-checkbox" onchange="toggleAllDates(this.checked)">
            <span>全选</span>
          </label>
        `;
        dateCheckboxes.appendChild(selectAllDiv);

        // 按日期排序
        filteredDates.sort((a, b) => a.date.localeCompare(b.date));

        // 创建复选框容器
        const checkboxesContainer = document.createElement("div");
        checkboxesContainer.className = "checkboxes-container";

        // 创建复选框
        filteredDates.forEach((dateInfo) => {
          const div = document.createElement("div");
          div.className = "date-option";
          div.innerHTML = `
            <label>
              <input type="checkbox" name="selected-dates" value="${dateInfo.date}">
              ${dateInfo.date} (${dateInfo.table})
            </label>
          `;
          checkboxesContainer.appendChild(div);
        });

        dateCheckboxes.appendChild(checkboxesContainer);

        // 重新添加无数据提示（隐藏状态）
        dateCheckboxes.appendChild(noDatesMessage);
      }

      // 全选/取消全选日期
      function toggleAllDates(checked) {
        const checkboxes = document.querySelectorAll(
          'input[name="selected-dates"]'
        );
        checkboxes.forEach((checkbox) => {
          checkbox.checked = checked;
        });
      }

      // 执行多天均值查询
      function executeDailyAveragesQuery(event) {
        event.preventDefault();

        // 收集选中的日期
        const selectedCheckboxes = document.querySelectorAll(
          'input[name="selected-dates"]:checked'
        );
        const dates = Array.from(selectedCheckboxes).map((cb) => cb.value);

        if (dates.length === 0) {
          showAlert("请至少选择一个日期", "warning");
          return;
        }

        const dataTypeKeyword =
          document.getElementById("data-type-keyword").value || "日前节点电价";

        // 构造参数
        const formData = new FormData();
        formData.append("dates", JSON.stringify(dates));
        formData.append("data_type_keyword", dataTypeKeyword);

        // 发送请求
        fetch("/daily-averages", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((err) => {
                throw new Error(err.detail || "查询失败");
              });
            }
            return response.json();
          })
          .then((data) => {
            // 无论是否有数据，都更新页面显示
            queryResult = data.data || [];
            displayResults();
            if (data.total > 0) {
              showAlert(
                "查询成功，共返回 " + data.total + " 条记录",
                "success"
              );
            } else {
              showAlert("查询成功，但没有找到匹配的数据", "warning");
            }
          })
          .catch((error) => {
            showAlert("查询失败: " + error.message, "error");
          });
      }

      // 显示查询结果
      function displayResults() {
        const resultSection = document.getElementById("result-section");
        resultSection.classList.remove("hidden");

        // 如果没有数据，显示空表格
        if (!queryResult || queryResult.length === 0) {
          document.getElementById("result-info").textContent = "总共 0 条记录";
          document.getElementById("result-header").innerHTML = "";
          document.getElementById("result-body").innerHTML =
            '<tr><td colspan="100%">无数据</td></tr>';
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        // 更新结果信息
        document.getElementById(
          "result-info"
        ).textContent = `总共 ${queryResult.length} 条记录，当前显示第 ${currentPage} 页`;

        // 创建表头
        const headerRow = document.getElementById("result-header");
        headerRow.innerHTML = "";
        const keys = Object.keys(queryResult[0]);
        keys.forEach((key) => {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        });

        // 分页显示数据
        renderPage(currentPage);
        setupPagination();
      }

      // 渲染当前页数据
      function renderPage(page) {
        const tbody = document.getElementById("result-body");
        tbody.innerHTML = "";

        // 如果没有数据，直接返回
        if (!queryResult || queryResult.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.textContent = "无数据";
          td.colSpan = 100; // 跨越所有列
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(
          startIndex + itemsPerPage,
          queryResult.length
        );
        const pageData = queryResult.slice(startIndex, endIndex);

        pageData.forEach((row) => {
          const tr = document.createElement("tr");
          Object.keys(row).forEach((key) => {
            const td = document.createElement("td");
            const value = row[key];

            // 特殊处理 record_time 字段
            if (
              key === "record_time" &&
              value !== null &&
              value !== undefined &&
              value !== ""
            ) {
              // 处理 timedelta 对象 (如: datetime.timedelta(seconds=3600))
              if (typeof value === "object" && value.seconds !== undefined) {
                const hours = Math.floor(value.seconds / 3600);
                const minutes = Math.floor((value.seconds % 3600) / 60);
                td.textContent = `${String(hours).padStart(2, "0")}:${String(
                  minutes
                ).padStart(2, "0")}`;
              }
              // 处理秒数格式 (如: 43200)
              else if (typeof value === "number") {
                const hours = Math.floor(value / 3600);
                const minutes = Math.floor((value % 3600) / 60);
                td.textContent = `${String(hours).padStart(2, "0")}:${String(
                  minutes
                ).padStart(2, "0")}`;
              }
              // 处理数值格式时间 (如: 900 表示 09:00)
              else if (
                typeof value === "string" &&
                !isNaN(parseInt(value)) &&
                parseInt(value) < 2400
              ) {
                const numValue = parseInt(value);
                const strValue = String(numValue).padStart(4, "0");
                const hour = strValue.substring(0, 2);
                const minute = strValue.substring(2, 4);
                td.textContent = `${hour}:${minute}`;
              }
              // 处理其他数字格式
              else if (typeof value === "string" && !isNaN(parseInt(value))) {
                const numValue = parseInt(value);
                const hours = Math.floor(numValue / 3600);
                const minutes = Math.floor((numValue % 3600) / 60);
                td.textContent = `${String(hours).padStart(2, "0")}:${String(
                  minutes
                ).padStart(2, "0")}`;
              }
              // 其他情况保持原样
              else {
                td.textContent = String(value);
              }
            } else {
              // 其他字段保持原样，包括value字段
              td.textContent = value !== null ? value : "";
            }

            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      // 设置分页控件
      function setupPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        // 如果没有数据，不显示分页控件
        if (!queryResult || queryResult.length === 0) {
          return;
        }

        const totalPages = Math.ceil(queryResult.length / itemsPerPage);

        // 如果只有一页，不显示分页控件
        if (totalPages <= 1) {
          return;
        }

        // 上一页按钮
        const prevButton = document.createElement("button");
        prevButton.textContent = "上一页";
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderPage(currentPage);
            setupPagination();
            document.getElementById(
              "result-info"
            ).textContent = `总共 ${queryResult.length} 条记录，当前显示第 ${currentPage} 页`;
          }
        };
        pagination.appendChild(prevButton);

        // 页码按钮
        for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement("button");
          pageButton.textContent = i;
          pageButton.classList.toggle("active", i === currentPage);
          pageButton.onclick = () => {
            currentPage = i;
            renderPage(currentPage);
            setupPagination();
            document.getElementById(
              "result-info"
            ).textContent = `总共 ${queryResult.length} 条记录，当前显示第 ${currentPage} 页`;
          };
          pagination.appendChild(pageButton);
        }

        // 下一页按钮
        const nextButton = document.createElement("button");
        nextButton.textContent = "下一页";
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderPage(currentPage);
            setupPagination();
            document.getElementById(
              "result-info"
            ).textContent = `总共 ${queryResult.length} 条记录，当前显示第 ${currentPage} 页`;
          }
        };
        pagination.appendChild(nextButton);
      }

      // 显示提示信息
      function showAlert(message, type) {
        // 移除现有的alert
        const existingAlert = document.querySelector(".alert");
        if (existingAlert) {
          existingAlert.remove();
        }

        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;

        const form = document.getElementById("daily-averages-form");
        form.parentNode.insertBefore(alert, form.nextSibling);

        // 3秒后自动移除
        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 3000);
      }
    </script>
  </body>
</html>
