<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>复盘诊断 - Excel2SQL</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/mobile.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
  <style>
    :root {
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --accent-color: #3b82f6;
    }
    body {
      background: var(--bg-color);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .navbar {
      background: var(--card-bg);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding-top: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }
    .navbar-brand,
    .navbar-brand:hover {
      color: var(--text-primary);
      font-weight: 800;
      font-size: 1.4rem;
      letter-spacing: -0.025em;
    }
    .navbar-nav { gap: 0.75rem; }
    .navbar-nav .nav-link {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 1.05rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .navbar-nav .nav-link:hover,
    .navbar-nav .nav-link:focus {
      color: var(--text-primary);
      background-color: rgba(0, 0, 0, 0.08);
    }
    .navbar-nav .nav-link.active {
      color: var(--accent-color);
      font-weight: 700;
      background-color: rgba(59, 130, 246, 0.12);
      border-bottom: 2px solid var(--accent-color);
    }
    .dashboard-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border: 1px solid rgba(15, 23, 42, 0.06);
    }
    .muted { color: var(--text-secondary); }
    .mono { font-variant-numeric: tabular-nums; }
    .table-sm td, .table-sm th { white-space: nowrap; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light mb-4">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="/"><i class="bi bi-grid-1x2-fill"></i> Excel2SQL</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain"
        aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="/">首页</a></li>
          <li class="nav-item"><a class="nav-link" href="/strategy_quote">报价申报</a></li>
          <li class="nav-item"><a class="nav-link active fw-bold" href="/strategy_review">策略复盘</a></li>
        </ul>
      </div>
      <a class="btn btn-outline-secondary btn-sm" href="/strategy_review"><i class="bi bi-arrow-left"></i> 返回复盘</a>
    </div>
  </nav>

  <div class="container-fluid px-4 py-4">
<div class="dashboard-card mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <h5 class="mb-0"><i class="bi bi-search text-primary"></i> 复盘诊断（对比缓存表）</h5>
          <div class="small muted">对比 `cache_daily_hourly` 的分时序列（价差/负荷预测/温度等）与当月基线（均值±1σ），定位异常小时。</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <select id="platformSelect" class="form-select form-select-sm" style="width: 120px;">
            <option value="tianlang">天朗</option>
            <option value="huihua">辉华</option>
          </select>
          <input id="diagDate" class="form-control form-control-sm mono" style="width: 140px;" placeholder="选择日期" readonly />
          <button id="btnLoad" type="button" class="btn btn-primary btn-sm"><i class="bi bi-play-fill"></i> 查看</button>
        </div>
      </div>
      <div id="errorBox" class="alert alert-danger mt-3 d-none"></div>
    </div>

    <div class="row g-3">
      <div class="col-12 col-xl-4">
        <div class="dashboard-card">
          <div class="small muted">诊断摘要</div>
          <div class="row g-2 mt-1">
            <div class="col-6">
              <div class="p-2 rounded bg-light">
                <div class="muted small">日期</div>
                <div class="fw-bold mono" id="sDate">-</div>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 rounded bg-light">
                <div class="muted small">月份</div>
                <div class="fw-bold mono" id="sMonth">-</div>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 rounded bg-light">
                <div class="muted small">Forecast 来源</div>
                <div class="fw-bold mono" id="sForecastSource">-</div>
              </div>
            </div>
            <div class="col-6">
              <div class="p-2 rounded bg-light">
                <div class="muted small">实际表</div>
                <div class="fw-bold mono" id="sActualTable">-</div>
              </div>
            </div>
            <div class="col-12">
              <div class="p-2 rounded bg-light">
                <div class="muted small">Top 异常小时（|Z| 最大）</div>
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>小时</th>
                        <th class="text-end">Z(价差)</th>
                        <th class="text-end">Z(负荷)</th>
                        <th class="text-end">Z(温度)</th>
                      </tr>
                    </thead>
                    <tbody id="topZBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="small muted mt-2">提示：Z = (当日值 - 月均) / 月σ，σ 为 0 或缺失时不计算。</div>
        </div>
      </div>

      <div class="col-12 col-xl-8">
        <div class="dashboard-card">
          <div class="row g-3">
            <div class="col-12">
              <div class="p-2 rounded bg-light">
                <div class="small muted mb-1">价差（DA-RT）：当日 vs 月均 ±1σ</div>
                <canvas id="chartDiff" height="120"></canvas>
              </div>
            </div>
            <div class="col-12 col-xl-6">
              <div class="p-2 rounded bg-light">
                <div class="small muted mb-1">负荷预测（cache）：当日 vs 月均 ±1σ</div>
                <canvas id="chartLoad" height="150"></canvas>
              </div>
            </div>
            <div class="col-12 col-xl-6">
              <div class="p-2 rounded bg-light">
                <div class="small muted mb-1">温度（cache）：当日 vs 月均 ±1σ</div>
                <canvas id="chartTemp" height="150"></canvas>
              </div>
            </div>
            <div class="col-12">
              <div class="p-2 rounded bg-light">
                <div class="small muted mb-1">收益差距来源（Top 小时：预期-真实）</div>
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>小时</th>
                        <th class="text-end">价差(DA-RT)</th>
                        <th class="text-end">实际</th>
                        <th class="text-end">申报</th>
                        <th class="text-end">系数</th>
                        <th class="text-end">真实(小时)</th>
                        <th class="text-end">预期(小时)</th>
                        <th class="text-end">预期-真实</th>
                      </tr>
                    </thead>
                    <tbody id="topGapBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="small muted mt-2" id="chartFallback" style="display:none;">图表库加载失败（离线/受限环境）。仍可查看表格。</div>
        </div>
      </div>
    </div>
  </div>

	  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
	    const SERVER_DEFAULT_PLATFORM = "{{ default_platform|default('tianlang') }}";

	    let chartDiff = null;
	    let chartLoad = null;
	    let chartTemp = null;

	    function normalizePlatform(v) {
	      const s = String(v || "").trim();
	      if (s === "huihua" || s === "辉华" || s === "HH" || s === "hh") return "huihua";
	      return "tianlang";
	    }

	    function getPlatform() {
	      const el = document.getElementById("platformSelect");
	      return normalizePlatform(el ? el.value : "tianlang");
	    }

	    function syncPlatformToUrl(platform) {
	      try {
	        const url = new URL(window.location.href);
	        url.searchParams.set("platform", platform);
	        window.history.replaceState({}, "", url.toString());
	      } catch {}
	    }

	    function applyPlatformToLinks(platform) {
	      // Keep navigation shareable (not only localStorage).
	      document.querySelectorAll('a[href^="/strategy_"]').forEach((a) => {
	        try {
	          const url = new URL(a.getAttribute("href"), window.location.origin);
	          url.searchParams.set("platform", platform);
	          a.setAttribute("href", url.pathname + "?" + url.searchParams.toString());
	        } catch {}
	      });
	    }

	    function initPlatform() {
	      const sel = document.getElementById("platformSelect");
	      if (!sel) return;
	      const qp = new URLSearchParams(window.location.search).get("platform");
	      const stored = localStorage.getItem("strategy_platform");
	      const initial = normalizePlatform(qp || stored || SERVER_DEFAULT_PLATFORM || "tianlang");
	      sel.value = initial;
	      localStorage.setItem("strategy_platform", initial);
	      syncPlatformToUrl(initial);
	      applyPlatformToLinks(initial);
	      sel.addEventListener("change", () => {
	        const p = getPlatform();
	        localStorage.setItem("strategy_platform", p);
	        syncPlatformToUrl(p);
	        applyPlatformToLinks(p);
	      });
	    }

    function fmt(n, digits=2) {
      if (n === null || n === undefined || Number.isNaN(Number(n))) return "-";
      return Number(n).toFixed(digits);
    }

    function showError(msg) {
      const el = document.getElementById("errorBox");
      el.textContent = msg;
      el.classList.remove("d-none");
    }
    function clearError() {
      const el = document.getElementById("errorBox");
      el.textContent = "";
      el.classList.add("d-none");
    }

    function ensureChartLib() {
      const ok = typeof Chart !== "undefined";
      document.getElementById("chartFallback").style.display = ok ? "none" : "block";
      return ok;
    }

    function destroyCharts() {
      if (chartDiff) { chartDiff.destroy(); chartDiff = null; }
      if (chartLoad) { chartLoad.destroy(); chartLoad = null; }
      if (chartTemp) { chartTemp.destroy(); chartTemp = null; }
    }

    function makeBandDatasets(avg, std, color) {
      const up = avg.map((v,i) => (v == null || std[i] == null) ? null : (v + std[i]));
      const lo = avg.map((v,i) => (v == null || std[i] == null) ? null : (v - std[i]));
      return [
        { label: "月均+1σ", data: up, borderColor: "rgba(0,0,0,0)", backgroundColor: "rgba(0,0,0,0)", pointRadius: 0, fill: false, spanGaps: true },
        { label: "月均-1σ", data: lo, borderColor: "rgba(0,0,0,0)", backgroundColor: color, pointRadius: 0, fill: "-1", spanGaps: true },
      ];
    }

    function render(d) {
      document.getElementById("sDate").textContent = d.date || "-";
      document.getElementById("sMonth").textContent = d.month || "-";
      document.getElementById("sForecastSource").textContent = d.forecast_source || "-";
      document.getElementById("sActualTable").textContent = (d.baseline && d.baseline.actual_table) || "-";

      const dayHours = (d.day && d.day.hours) || [];
      const baseHours = (d.baseline && d.baseline.hours) || [];
      const labels = Array.from({length:24}, (_,i)=>String(i).padStart(2,"0"));

      const dayDiff = dayHours.map(r => r.price_diff ?? null);
      const dayLoad = dayHours.map(r => r.load_forecast ?? null);
      const dayTemp = dayHours.map(r => r.temperature ?? null);

      const avgDiff = baseHours.map(r => r.price_diff_avg ?? null);
      const stdDiff = baseHours.map(r => r.price_diff_std ?? null);
      const avgLoad = baseHours.map(r => r.load_forecast_avg ?? null);
      const stdLoad = baseHours.map(r => r.load_forecast_std ?? null);
      const avgTemp = baseHours.map(r => r.temperature_avg ?? null);
      const stdTemp = baseHours.map(r => r.temperature_std ?? null);

      destroyCharts();
      if (!ensureChartLib()) return;

      chartDiff = new Chart(document.getElementById("chartDiff"), {
        type: "line",
        data: {
          labels,
          datasets: [
            ...makeBandDatasets(avgDiff, stdDiff, "rgba(59,130,246,0.12)"),
            { label: "月均", data: avgDiff, borderColor: "rgba(59,130,246,0.45)", borderDash: [6,4], tension: 0.2, pointRadius: 0, spanGaps: true },
            { label: "当日", data: dayDiff, borderColor: "#3b82f6", tension: 0.2, spanGaps: true },
          ],
        },
        options: { responsive: true, plugins: { legend: { position: "top" } } },
      });

      chartLoad = new Chart(document.getElementById("chartLoad"), {
        type: "line",
        data: {
          labels,
          datasets: [
            ...makeBandDatasets(avgLoad, stdLoad, "rgba(17,24,39,0.10)"),
            { label: "月均", data: avgLoad, borderColor: "rgba(17,24,39,0.40)", borderDash: [6,4], tension: 0.2, pointRadius: 0, spanGaps: true },
            { label: "当日", data: dayLoad, borderColor: "#111827", tension: 0.2, spanGaps: true },
          ],
        },
        options: { responsive: true, plugins: { legend: { position: "top" } } },
      });

      chartTemp = new Chart(document.getElementById("chartTemp"), {
        type: "line",
        data: {
          labels,
          datasets: [
            ...makeBandDatasets(avgTemp, stdTemp, "rgba(245,158,11,0.12)"),
            { label: "月均", data: avgTemp, borderColor: "rgba(245,158,11,0.45)", borderDash: [6,4], tension: 0.2, pointRadius: 0, spanGaps: true },
            { label: "当日", data: dayTemp, borderColor: "#f59e0b", tension: 0.2, spanGaps: true },
          ],
        },
        options: { responsive: true, plugins: { legend: { position: "top" } } },
      });

      // Top Z table
      const zb = document.getElementById("topZBody");
      zb.innerHTML = "";
      for (const t of (d.day && d.day.top_z_hours) || []) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${String(t.hour).padStart(2,"0")}:00</td>
          <td class="text-end mono">${fmt(t.z_price_diff, 2)}</td>
          <td class="text-end mono">${fmt(t.z_load_forecast, 2)}</td>
          <td class="text-end mono">${fmt(t.z_temperature, 2)}</td>
        `;
        zb.appendChild(tr);
      }

      // Top gap hours (PnL explanation)
      const gb = document.getElementById("topGapBody");
      gb.innerHTML = "";
      for (const t of (d.day && d.day.top_hours) || []) {
        const h = t.hour;
        const r = dayHours[h] || {};
        const gap = t.profit_gap;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${String(h).padStart(2,"0")}:00</td>
          <td class="text-end mono">${fmt(r.price_diff, 2)}</td>
          <td class="text-end mono">${fmt(r.actual, 4)}</td>
          <td class="text-end mono">${fmt(r.declared, 3)}</td>
          <td class="text-end mono">${fmt(r.coeff, 3)}</td>
          <td class="text-end mono ${t.profit_raw > 0 ? 'text-success' : (t.profit_raw < 0 ? 'text-danger' : '')}">${fmt(t.profit_raw, 2)}</td>
          <td class="text-end mono ${t.profit_expected > 0 ? 'text-success' : (t.profit_expected < 0 ? 'text-danger' : '')}">${fmt(t.profit_expected, 2)}</td>
          <td class="text-end mono ${gap > 0 ? 'text-primary' : (gap < 0 ? 'text-warning' : '')}">${fmt(gap, 2)}</td>
        `;
        gb.appendChild(tr);
      }
    }

	    async function load() {
	      clearError();
	      const date = document.getElementById("diagDate").value;
	      if (!date) return;
	      const platform = getPlatform();
	      const btn = document.getElementById("btnLoad");
	      const old = btn.innerHTML;
	      btn.disabled = true;
	      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>加载中';
	      try {
	        const res = await fetch(`/api/strategy/review/diagnose?date=${encodeURIComponent(date)}&platform=${encodeURIComponent(platform)}`);
	        const json = await res.json();
	        if (!res.ok) {
	          showError(json.detail || "加载失败");
          return;
        }
        render(json);
      } finally {
        btn.disabled = false;
        btn.innerHTML = old;
      }
    }

    // init date picker with query param (server renders it into template var)
	    const initialDate = "{{ date or '' }}";
	    initPlatform();
	    flatpickr("#diagDate", {
	      locale: "zh",
      dateFormat: "Y-m-d",
      defaultDate: initialDate || null,
      allowInput: false,
      clickOpens: true,
      disableMobile: true,
    });
    document.getElementById("btnLoad").addEventListener("click", load);
    if (initialDate) load();
  </script>
</body>
</html>
